FISH SHELL SCRIPT AUDIT PROMPT
===============================
Version: 7.1.0
Derived from: ry-install.fish v3.0.0 audit (2026-02-27)
Changed: 7.1.0 Sync v2.8.9→v3.0.0: fish_indent canonical formatting;
               README structured tables; changelog kernel.org style.
         7.0.0 Sync v2.8.3→v2.8.9: isatty 1 guard in do_watch (v2.8.4);
               comment/README trimming (v2.8.5-v2.8.9); 326 checks (was 325).
               Rewrite: consolidate passes, trim setup/explanations (~55% smaller).
         (Full history: 3.3.0→6.0.0 in git)
Checks: 326
Phases: 13 (11 static + 1 runtime + 1 gap analysis)

PURPOSE
-------
326-check audit for production fish scripts managing system config,
sudo, credentials, embedded configs, and multi-mode dispatch with
backup/verification subsystems.

ZERO-SKIP: Every source line analyzed. No sampling. Trace all code
paths including error branches, unreachable code, early returns.

KEY LESSONS (encoded as checks):
  - Static analysis misses execution-order bugs → Phase 12
  - Fish redirects resolve BEFORE command runs → 242
  - Pre-lock validation: validate → lock → execute → 230
  - mkdir-only lock (no flock/exec fd since v2.8.2) → 218, 324
  - Dispatch args quoted → 231
  - Named constants for all thresholds → 247-258
  - check_deps matches actual usage → 272
  - --watch --once tty gate relaxation → 314-316
  - --profile stderr + NO_COLOR → 325
  - do_watch isatty 1 color guard (v2.8.4) → 326

───────────────────────────────────────────────────────────────
 SETUP
───────────────────────────────────────────────────────────────

STEP 0: COPY + TOOLS

  ```bash
  mkdir -p /home/claude/audit-{src,data}
  cp /mnt/user-data/uploads/<file> /home/claude/audit-src/script.fish
  wc -l /home/claude/audit-src/script.fish

  apt-get update -q 2>/dev/null && \
    apt-get install -y fish ripgrep fd-find bat 2>/dev/null; true
  for pair in "fdfind fd" "batcat bat"; do
    set -- $pair; src="$1" dst="$2"
    if command -v "$src" >/dev/null 2>&1 && ! command -v "$dst" >/dev/null 2>&1; then
      ln -sf "$(command -v "$src")" "/usr/local/bin/$dst"
    fi
  done
  for t in fish rg fd bat; do
    command -v "$t" >/dev/null 2>&1 && echo "$t: OK" || echo "$t: missing"
  done
  ```

  Fallbacks (if tools unavailable):
  ```bash
  command -v rg  >/dev/null 2>&1 || rg()  { grep -P --color=never "$@"; }
  command -v bat >/dev/null 2>&1 || bat() {
    local args=() range=""
    while [[ $# -gt 0 ]]; do
      case "$1" in --plain) shift ;; -r) shift; range="$1"; shift ;; *) args+=("$1"); shift ;; esac
    done
    if [[ -n "$range" ]]; then sed -n "${range%%:*},${range##*:}p" "${args[-1]}"; else cat "${args[@]}"; fi
  }
  command -v fd  >/dev/null 2>&1 || fd() { local pat="$1"; shift; find "$@" -name "$pat" 2>/dev/null; }
  command -v sd  >/dev/null 2>&1 || sd() { sed -i "s/$1/$2/g" "${@:3}"; }
  export -f rg bat fd sd 2>/dev/null; true
  ```

FISH SYNTAX (auditor reference):
  $var (not ${var}) · (command) (not $(command)) · test/string (not [[]])
  set -gx (not export) · ; and / ; or (not &&/||) · set --erase (not set -e)
  for x in $ARRAY unquoted · "text"(cmd) is valid concat · -- before args
  read -P "prompt: " var · read -sP for hidden input
  REDIRECT BUG: < nonexistent 2>/dev/null leaks warnings → use cat -- 2>/dev/null

CONFIG SYNTAX: see userPreferences [AUDIT] section
CROSS-REFS: see userPreferences [AUDIT] cross_refs

───────────────────────────────────────────────────────────────
 EXECUTION
───────────────────────────────────────────────────────────────

RULES: Work continuously. Batch tool calls. Parallel when independent.
  >60 lines output → file first. >3 calls with no findings → flush.
  Blocked → DEFERRED, continue. Save after EVERY pass. Max 3 retries.
  Never re-read same region twice. >10 items → sub-chunks of 5.
  Write findings: echo "F-N ..." >> /home/claude/audit-findings.txt

ORDER:
  PASS 1 — DATA GATHER    phases 1-11  (compound parallel commands)
  PASS 2 — STATIC         phases 1-11  (analyze gathered data)
  PASS 3 — RUNTIME        phase 12     (fish execution tests)
  PASS 4 — GAP ANALYSIS   phase 13     (race/error/edge tracing)
  PASS 5 — FINALIZE       —            (summary + spec + zip)

PASS 1: DATA GATHERING (single compound block)

  ```bash
  F=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data
  mkdir -p "$D"

  # P1-5: syntax, routing, errors, vars, security
  (
    echo "=== BASHISMS ==="
    rg -n '\$\(|export |&&|\|\||set -e |\$\{|functions -e|unset |local ' "$F"
    echo "=== STRING OPS ==="
    rg -n 'string (match|replace|split|join|trim)' "$F" | rg -v -- '--'
    echo "=== ARGPARSE ===" && rg -n 'argparse|argv' "$F"
    echo "=== ROUTING ===" && rg -n '>&2|>/dev/null|stderr|stdout' "$F"
    echo "=== NO_COLOR ===" && rg -n 'NO_COLOR|isatty|tput|test -t' "$F"
    echo "=== EXIT/RETURN ===" && rg -n 'exit [0-9]|return [0-9]|exit$' "$F"
    echo "=== STATUS ===" && rg -n '\$status|\$pipestatus' "$F"
    echo "=== SIGNALS ===" && rg -n 'trap|--on-signal|--on-event|fish_exit' "$F"
    echo "=== CLEANUP ===" && rg -n 'mktemp|rm -f|rm -rf|cleanup|_do_cleanup' "$F"
    echo "=== SCOPE ===" && rg -n 'set -[glx]|set --erase|set --global|set --local' "$F"
    echo "=== FOR LOOPS ===" && rg -n 'for .* in ' "$F"
    echo "=== INJECTION ===" && rg -n 'eval|source ' "$F"
    echo "=== CREDS ===" && rg -ni 'password|passphrase|credential|secret|WIFI_PASS' "$F"
    echo "=== PERMS ===" && rg -n 'chmod|chown|0600|0644|0700|0755' "$F"
    echo "=== SUDO ===" && rg -n 'sudo |_IS_ROOT' "$F"
    echo "=== EXT CMDS ===" && rg -n 'command -q|command -v' "$F"
  ) > "$D/p1-5.txt" 2>&1 &

  # P6-7: embedded configs, cross-refs
  (
    echo "=== CONFIG FORMATS ===" && rg -n '\\[Unit\\]|\\[Service\\]|\\[Install\\]' "$F"
    echo "=== SYSTEMD ===" && rg -n 'ExecStart|After=|Type=' "$F"
    echo "=== UDEV ===" && rg -n 'ACTION==|SUBSYSTEM==|ATTR{' "$F"
    echo "=== DESTINATIONS ===" && rg -n 'SERVICE_DESTINATIONS|amdgpu-performance|cpupower-epp' "$F"
    echo "=== SDBOOT ===" && rg -n 'LINUX_FALLBACK_OPTIONS|SDBOOT' "$F"
    echo "=== VERSION ===" && rg -n 'VERSION|SYSTEM_DEST|USER_DEST|SERVICE_DEST|get_file_content|MASK' "$F"
    echo "=== DISPATCH ===" && rg -n 'do_\w+ \$\|do_\w+ "\$' "$F" | rg -v 'function |#|_log'
    echo "=== WATCH ===" && rg -n 'WATCH_INTERVAL|WATCH_ONCE|do_watch|--watch|--once' "$F"
    echo "=== PROFILE ===" && rg -n 'PROFILE|profile' "$F"
  ) > "$D/p6-7.txt" 2>&1 &

  # P8-11: architecture, patterns, docs, testing
  (
    echo "=== FUNCTIONS ===" && rg -n '^function |^end$' "$F"
    echo "=== ARITY ===" && rg -n 'count \$argv|test .* -ne |test .* -lt ' "$F"
    echo "=== ATOMIC ===" && rg -n 'mv |install_file|chmod.*mv' "$F"
    echo "=== LOCK ===" && rg -n 'mkdir.*lock|rmdir.*lock|kill -0|LOCK|flock|exec 9' "$F"
    echo "=== LOG ===" && rg -n '_log|_json_str|NDJSON|log_file|\.jsonl' "$F"
    echo "=== BACKUP ===" && rg -n '_backup_|BACKUP_BASE|BACKUP_DIR|MAX_BACKUPS' "$F"
    echo "=== ARGPARSE TMP ===" && rg -n 'ry-argparse|_argparse_tmp' "$F"
    echo "=== ANTIPATTERNS ===" && rg -n 'cat .* \| |test .* = ""|head -1|tail -1' "$F"
    echo "=== REDIRECT BUG ===" && rg -n 'string trim.*<|string match.*<' "$F" | rg -v '#'
    echo "=== MAGIC NUMS ===" && rg -n 'TEMP_|DISK_|BOOT_|MAX_|CACHE_|ROOT_AVAIL|NVME_LIFE|WATCH_INTERVAL' "$F"
    echo "=== DRY ===" && rg -n 'DRY|dry.run|--dry-run|\[DRY\]' "$F"
    echo "=== TEST_ALL ===" && rg -n 'do_test_all|verify.static|verify.runtime' "$F"
    echo "=== ISATTY ===" && rg -n 'isatty|test -t' "$F"
    echo "=== ROLLBACK ===" && rg -n 'rollback|undo|revert|restore|_backup' "$F"
    echo "=== PRE-LOCK ===" && rg -n 'case install-file|case install|_acquire_lock' "$F"
  ) > "$D/p8-11.txt" 2>&1 &

  wait
  wc -l "$D"/*.txt
  ```

PASS 3: RUNTIME (phase 12)

  ```bash
  S=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data/runtime
  mkdir -p "$D"

  # stdout/stderr separation
  fish "$S" --help    >"$D/help-out.txt"  2>"$D/help-err.txt"  &
  fish "$S" -h        >"$D/h-out.txt"     2>"$D/h-err.txt"     &
  fish "$S" --version >"$D/ver-out.txt"   2>"$D/ver-err.txt"   &
  fish "$S" -v        >"$D/v-out.txt"     2>"$D/v-err.txt"     &
  wait

  # exit code matrix
  for mode in \
    "--help" "-h" "--version" "-v" "--bogus" "--fix" "--stress" "--json" \
    "--diff --lint" "--interval" "--interval abc" "--interval 0" "--interval -5" \
    "--once" "--verify-static" "--verify-runtime" "--lint" "--test-all" \
    "--clean --dry-run" "--completions" "--diff" "--diagnose" \
    "--install-file" "--install-file /etc/kernel/cmdline --dry-run" \
    "--logs" "--logs list" "--logs system" "--logs analyze" \
    "--diagnose --json" "--json" "--watch" "--watch --once" \
    "--no-log --version" "--no-log --lint" \
    "--diff /etc/kernel/cmdline" "--diff relative/path" \
    "--profile --dry-run"; do
    fish "$S" $mode >/dev/null 2>&1
    printf '%s → %d\n' "$mode" "$?" >> "$D/exit-codes.txt"
  done

  # --profile timing
  fish "$S" --dry-run --profile --no-color >"$D/profile-out.txt" 2>"$D/profile-err.txt"
  fish "$S" --dry-run --no-color >"$D/noprofile-out.txt" 2>"$D/noprofile-err.txt"

  # --watch --once non-tty
  echo "" | fish "$S" --watch --once >"$D/once-notty-out.txt" 2>"$D/once-notty-err.txt"
  printf '--watch --once non-tty → %d\n' "$?" >> "$D/exit-codes.txt"

  # --watch non-tty without --once (expect exit 1)
  echo "" | fish "$S" --watch >"$D/watch-notty-out.txt" 2>"$D/watch-notty-err.txt"
  printf '--watch non-tty → %d\n' "$?" >> "$D/exit-codes.txt"

  # NO_COLOR enforcement
  for mode in "--lint" "--diff" "--dry-run" "--diagnose" "--logs list"; do
    NO_COLOR=1 fish "$S" $mode --no-color 2>"$D/nocolor-$mode.txt" >/dev/null &
  done
  wait

  # DRY-RUN filesystem safety
  stat -c '%n %Y' /etc/modprobe.d/* 2>/dev/null | sort > "$D/pre-dry.txt"
  fish "$S" --dry-run >"$D/dry-out.txt" 2>"$D/dry-err.txt"
  stat -c '%n %Y' /etc/modprobe.d/* 2>/dev/null | sort > "$D/post-dry.txt"
  diff "$D/pre-dry.txt" "$D/post-dry.txt" > "$D/dry-diff.txt"

  # Misc
  fish "$S" --lint >"$D/lint-out.txt" 2>"$D/lint-err.txt"
  fish "$S" --no-log --version >"$D/nolog-out.txt" 2>"$D/nolog-err.txt"
  rg 'Log file:' "$D/nolog-err.txt" > "$D/nolog-check.txt" 2>/dev/null

  # Fish redirect regression
  fish -c '
    set result (string trim -- (cat -- /nonexistent/path 2>/dev/null))
    echo "result: [$result]"
  ' >"$D/redirect-out.txt" 2>"$D/redirect-err.txt"

  # Analyze
  echo "=== STDERR BYTES (expect 0 for help/version) ===" && wc -c "$D"/{help,h,ver,v}-err.txt
  echo "=== EXIT CODES ===" && bat --plain "$D/exit-codes.txt"
  echo "=== ANSI (expect 0) ===" && rg -cP '\x1b\[' "$D"/nocolor-*.txt 2>/dev/null || echo "none"
  echo "=== DRY-RUN FS (expect empty) ===" && bat --plain "$D/dry-diff.txt"
  echo "=== LINT ===" && bat --plain "$D/lint-err.txt"
  echo "=== NO-LOG (expect empty) ===" && bat --plain "$D/nolog-check.txt"
  echo "=== WATCH NON-TTY ===" && bat --plain "$D/watch-notty-err.txt"
  echo "=== WATCH --ONCE ===" && wc -c "$D/once-notty-err.txt" && bat --plain "$D/once-notty-out.txt" | head -5
  echo "=== REDIRECT ===" && bat --plain "$D/redirect-err.txt"
  echo "=== PROFILE ===" && rg -c '\[PROFILE\]' "$D/profile-err.txt" 2>/dev/null || echo "0"
  echo "=== NO PROFILE (expect 0) ===" && rg -c '\[PROFILE\]' "$D/noprofile-err.txt" 2>/dev/null || echo "0"
  ```

PASS 4: GAP ANALYSIS (phase 13)

  ```bash
  F=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data

  # Tmpfile lifecycle per function
  for func in $(rg -oP '(?<=^function )\w+' "$F" | sort -u); do
    if rg -A 50 "^function $func" "$F" | rg -q 'mktemp'; then
      echo "--- $func ---"
      rg -A 50 "^function $func" "$F" | rg 'mktemp|rm -f|return|set --erase'
    fi
  done > "$D/gap-tmpfile.txt"

  # DRY-RUN gate coverage
  rg -n 'sudo |pacman |systemctl |mv |tee ' "$F" | rg -v 'DRY|_run|#|echo|rg|string' > "$D/gap-dry.txt"

  # Lock regression (expect 0 flock hits)
  rg -n 'flock|exec 9|_LOCK_METHOD.*flock' "$F" > "$D/gap-lock-regression.txt"
  rg -n 'mkdir.*LOCK|rmdir.*LOCK|verify_pid' "$F" > "$D/gap-lock-trace.txt"

  # Argparse temp lifecycle
  rg -n 'ry-argparse|_argparse_tmp' "$F" > "$D/gap-argparse.txt"

  # Ext command coverage
  rg -oP '(?:sudo\s+)?(?:command\s+)?\b(pacman|systemctl|mkinitcpio|modprobe|udevadm|systemd-analyze|journalctl|findmnt|lsblk|ip|tee|install|mkdir|chmod|chown|mv|cp|rm|cat|sort|wc|diff|date|sleep|kill|pkill|stat|head|tail|cut|tr|awk|sed|grep|find|mktemp|read)\b' "$F" | sort -u > "$D/gap-ext-cmds.txt"
  rg -oP 'command -q\s+(\w+)' "$F" | sort -u > "$D/gap-cmd-checks.txt"
  echo "=== Unchecked commands ===" && comm -23 "$D/gap-ext-cmds.txt" "$D/gap-cmd-checks.txt"

  wc -l "$D"/gap-*.txt
  ```

═══════════════════════════════════════════════════════════════
 PHASE 1: FISH SYNTAX & COMPLIANCE (20 checks)
═══════════════════════════════════════════════════════════════

  Exempt: Hits in embedded content (ExecStart, awk, heredocs, lint
  self-checkers) are NOT findings.

  1.1  BASHISMS
       [ ] 1. $()  [ ] 2. [[]]  [ ] 3. export  [ ] 4. &&/||
       [ ] 5. ${var}  [ ] 6. set -e VAR  [ ] 7. functions -e
       [ ] 8. unset  [ ] 9. source (verify correct usage)  [ ] 10. local

  1.2  VERSION GATE
       [ ] 11. Fish version checked before executing
       [ ] 12. Minimum version matches features used

  1.3  STRING OPS
       [ ] 13. -- separator before arguments
       [ ] 14. No sed/awk/grep where string builtins suffice
       [ ] 15. string match uses -q for boolean tests

  1.4  OPTION PARSING
       [ ] 16. argparse used  [ ] 17. Unknown opts → error + usage
       [ ] 18. -- handled

  1.5  SYNTAX VALIDATION
       [ ] 19. fish --no-execute passes  [ ] 20. Embedded fish valid

═══════════════════════════════════════════════════════════════
 PHASE 2: STDERR / STDOUT ROUTING (18 checks)
═══════════════════════════════════════════════════════════════

  2.1  OUTPUT CONTRACT
       [ ] 21. Diagnostics → stderr  [ ] 22. Machine data → stdout
       [ ] 23. --help → stdout  [ ] 24. --version → stdout
       [ ] 25. Errors → stderr  [ ] 26. --help: 0 stderr bytes
       [ ] 27. --version: 0 stderr bytes
       [ ] 28. Bad option: help to stderr, 0 stdout bytes

  2.2  MESSAGE FUNCTIONS
       [ ] 29. Central _msg routes to stderr
       [ ] 30. NO_COLOR env respected  [ ] 31. --no-color flag respected
       [ ] 32. isatty check (test -t 2)
       [ ] 33. Levels consistent (ok/fail/info/warn/err/dry)

  2.3  COMMAND OUTPUT
       [ ] 34. Wrapped stdout preserved  [ ] 35. Wrapped stderr captured
       [ ] 36. Quiet mode suppresses stdout  [ ] 37. Verbose shows detail

  2.4  EXECUTION ORDER
       [ ] 38. Root check/env setup silent before --help/--version parse

═══════════════════════════════════════════════════════════════
 PHASE 3: ERROR HANDLING & EXIT CODES (23 checks)
═══════════════════════════════════════════════════════════════

  3.1  EXIT CODES
       [ ] 39. 0: success/help/version  [ ] 40. 1: runtime errors
       [ ] 41. 2: usage errors  [ ] 42. 130: SIGINT (128+2)
       [ ] 43. Functions use return not exit
       [ ] 44. No bare exit without code  [ ] 45. No exit inside functions

  3.2  STATUS CAPTURE
       [ ] 46. $status captured immediately  [ ] 47. $pipestatus for pipes
       [ ] 48. Not clobbered by _log/_msg  [ ] 49. No intervening calls

  3.3  SIGNAL HANDLERS
       [ ] 50. INT  [ ] 51. TERM  [ ] 52. HUP  [ ] 53. fish_exit
       [ ] 54. Handlers don't mask exit code

  3.4  CLEANUP GUARANTEE
       [ ] 55. Temp files  [ ] 56. Lock files  [ ] 57. Background procs
       [ ] 58. Credentials erased  [ ] 59. Sudo keepalive terminated
       [ ] 60. Cleanup idempotent  [ ] 61. UID-scoped /tmp sweep

═══════════════════════════════════════════════════════════════
 PHASE 4: VARIABLE HANDLING (24 checks)
═══════════════════════════════════════════════════════════════

  4.1  SCOPE
       [ ] 62. Globals: set -g  [ ] 63. Locals: set -l
       [ ] 64. Exports: set -gx  [ ] 65. No scope leaks
       [ ] 66. Loop vars scoped  [ ] 67. No top-level set without flag

  4.2  set --erase AUDIT
       [ ] 68. Modern syntax (not set -e)  [ ] 69. No unnecessary 2>/dev/null
       [ ] 70. Creds erased on ALL paths  [ ] 71. Consistent style

  4.3  FOR-LOOP VARIABLES
       [ ] 72. Unquoted: for x in $ARRAY  [ ] 73. Never "for x in "$ARRAY""
       [ ] 74. Empty array safe

  4.4  UNNECESSARY REDIRECTS ON BUILTINS
       [ ] 75. No 2>/dev/null on set  [ ] 76. No 2>/dev/null on command -q
       [ ] 77. OK on set -l var (external-cmd) — suppresses cmd stderr

  4.5  NAMING
       [ ] 78. UPPER_SNAKE user globals  [ ] 79. _UPPER internal globals
       [ ] 80. lower_snake locals  [ ] 81. Functions lowercase+underscore
       [ ] 82. No single-letter outside tight loops  [ ] 83. Flag if found

  4.6  QUOTING
       [ ] 84. Vars quoted in test/string  [ ] 85. Paths always quoted

═══════════════════════════════════════════════════════════════
 PHASE 5: SECURITY (37 checks)
═══════════════════════════════════════════════════════════════

  5.1  COMMAND INJECTION
       [ ] 86. No eval  [ ] 87. Input validated  [ ] 88. -- separators
       [ ] 89. No unchecked interpolation  [ ] 90. No var-as-command
       [ ] 91. Only $argv in _run-style wrappers

  5.2  TEMP FILES
       [ ] 92. mktemp  [ ] 93. TOCTOU mitigated  [ ] 94. mktemp fail handled
       [ ] 95. Cleaned on all paths  [ ] 96. UID-owned  [ ] 97. Unique prefix
       [ ] 98. No predictable names in /tmp

  5.3  CREDENTIAL HANDLING
       [ ] 99. read -s  [ ] 100. Erased after use  [ ] 101. Redacted in logs
       [ ] 102. 0600 perms  [ ] 103. Not in CLI args  [ ] 104. Not exported
       [ ] 105. Special chars escaped

  5.4  FILE PERMISSIONS
       [ ] 106. System: 644  [ ] 107. User: 600  [ ] 108. Creds: 600
       [ ] 109. Logs: 600  [ ] 110. Backup dirs: 700
       [ ] 111. chmod before mv

  5.5  PRIVILEGE SEPARATION
       [ ] 112. Root warning/abort  [ ] 113. Root → forced dry-run
       [ ] 114. sudo least privilege  [ ] 115. Keepalive lifecycle
       [ ] 116. Restricted sudo handled

  5.6  INPUT VALIDATION
       [ ] 117. Interface names  [ ] 118. SSIDs (1-32, no metachar, no %)
       [ ] 119. Passphrases (8-63, no newlines)  [ ] 120. Country codes
       [ ] 121. Paths (canonical, no traversal)  [ ] 122. Numeric ranges

═══════════════════════════════════════════════════════════════
 PHASE 6: EMBEDDED CONFIG CONTENT (47 checks)
═══════════════════════════════════════════════════════════════

  3 arrays: SYSTEM (12), USER (3), SERVICE (2) = 17 files.

  6.1  SYSTEMD-BOOT
       [ ] 123. key<space>value (no =)  [ ] 124. Valid keys only

  6.2  KERNEL CMDLINE
       [ ] 125. rw root=UUID=<uuid>  [ ] 126. UUID dynamic
       [ ] 127. Space-separated, no trailing ws
       [ ] 128. modprobe.d blacklist-only (no options since v2.5.0)

  6.3  SDBOOT-MANAGE
       [ ] 129. KEY="VALUE"  [ ] 130. Required keys present
       [ ] 131. FALLBACK="quiet"  [ ] 132. OPTIONS ⊇ KERNEL_PARAMS

  6.4  MKINITCPIO
       [ ] 133. MODULES=() HOOKS=() COMPRESSION=""
       [ ] 134. base first  [ ] 135. systemd before sd-vconsole
       [ ] 136. keyboard before sd-vconsole  [ ] 137. filesystems before fsck
       [ ] 138. Modules validated via modprobe -n

  6.5  MODPROBE
       [ ] 139. No "options" lines (regression)  [ ] 140. blacklist format
       [ ] 141. Modules validated  [ ] 142. Cross-ref with cmdline

  6.6  MODULES-LOAD
       [ ] 143. One module per line, no options

  6.7  UDEV
       [ ] 144. == for match  [ ] 145. = for assign
       [ ] 146. ATTR{} correct  [ ] 147. No empty match values

  6.8  SYSTEMD UNITS
       [ ] 148. [Unit] [Service] [Install]  [ ] 149. After= correct
       [ ] 150. ExecStart absolute paths  [ ] 151. systemd-analyze verify
       [ ] 152. Type= matches behavior
       [ ] 153. amdgpu-performance: bash -c, retry, /sys/class/drm, graphical.target
       [ ] 154. cpupower-epp: bash -c, EPP path, After=cpupower, multi-user, Timeout

  6.9  DROP-INS
       [ ] 155. No journald.conf.d (removed v2.5.0, regression)
       [ ] 156. No coredump.conf.d (removed v2.5.0, regression)
       [ ] 157. resolved: [Resolve] not [Resolved]
       [ ] 158. logind: [Login] section

  6.10 IWD
       [ ] 159. [General] [DriverQuirks] [Network]  [ ] 160. Valid keys

  6.11 NETWORKMANAGER
       [ ] 161. [device] [connection] [logging]
       [ ] 162. wifi.powersave correct  [ ] 163. wifi.backend matches

  6.12 WIRELESS-REGDOM
       [ ] 164. WIRELESS_REGDOM="XX"

  6.13 ENVIRONMENT.D
       [ ] 165. KEY=VALUE (no export/quotes)  [ ] 166. XDG_RUNTIME_DIR

  6.14 FISH CONFIGS
       [ ] 167. fish --no-execute valid  [ ] 168. Guards present
       [ ] 169. SSH auth sock priority (forwarded > gcr > systemd)

═══════════════════════════════════════════════════════════════
 PHASE 7: CROSS-REFERENCES & CONSISTENCY (25 checks)
═══════════════════════════════════════════════════════════════

  7.1  VERSION SYNC
       [ ] 170. Header = global  [ ] 171. Global = README
       [ ] 172. Changelog entry exists  [ ] 173. Lint verifies auto

  7.2  FILE COUNTS
       [ ] 174. SYSTEM count = get_file_content cases
       [ ] 175. USER count = get_file_content glob cases
       [ ] 176. SERVICE count = get_file_content service cases
       [ ] 177. Progress steps = actual calls
       [ ] 178. README count = total  [ ] 179. '*' fallback returns 1

  7.3  PARAMETER CROSS-REFS
       [ ] 180. modprobe.d blacklist-only (regression)
       [ ] 181. MKINITCPIO_MODULES match hardware
       [ ] 182. Blacklist consistent cmdline↔modprobe
       [ ] 183. ENV_VARS match environment.d↔runtime verify

  7.4  README ↔ HELP
       [ ] 184. All --help options in README
       [ ] 185. Sub-options documented (--diff --fix, --watch --once, etc.)
       [ ] 186. Modifiers as separate entries (--fix, --stress, --json, etc.)
       [ ] 187. --logs sub-targets documented
       [ ] 188. --install-file documented  [ ] 189. Exit codes documented
       [ ] 190. Prerequisites listed

  7.5  MODE CROSS-REFS
       [ ] 191. --watch + --interval in README  [ ] 192. --no-log in README
       [ ] 193. --watch --once in README  [ ] 194. --profile in README

═══════════════════════════════════════════════════════════════
 PHASE 8: FUNCTION ARCHITECTURE (37 checks)
═══════════════════════════════════════════════════════════════

  8.1  ARITY
       [ ] 195. Count validated at entry  [ ] 196. Error messages show counts
       [ ] 197. Return 1 on error (not exit)

  8.2  ATOMIC FILE OPS
       [ ] 198. Write to tmp first  [ ] 199. Perms before mv
       [ ] 200. Atomic mv (same fs)  [ ] 201. Symlink detection
       [ ] 202. Owner/group correct

  8.3  IDEMPOTENCY
       [ ] 203. Re-run identical  [ ] 204. Diff-before-write skip
       [ ] 205. pacman --needed  [ ] 206. Service enable idempotent

  8.4  LOGGING
       [ ] 207. JSONL format  [ ] 208. Timestamps  [ ] 209. Sensitive redacted
       [ ] 210. MAX_LOGS rotation  [ ] 211. Log perms 0600
       [ ] 212. _json_str escaping

  8.5  LOCK FILE
       [ ] 213. Prevents concurrent  [ ] 214. mkdir-only (since v2.8.2)
       [ ] 215. Stale reclaim (kill -0 + find + rmdir + re-mkdir)
       [ ] 216. Cleaned on all paths  [ ] 217. PID in lock dir
       [ ] 218. REGRESSION: rg 'flock|exec 9|_LOCK_METHOD.*flock' → 0 hits

  8.6  BACKUP
       [ ] 219. _backup_init dated dir  [ ] 220. _backup_path preserves structure
       [ ] 221. _backup_boot flat /boot  [ ] 222. MAX_BACKUPS rotation
       [ ] 223. 700 perms  [ ] 224. Called before mutation

  8.7  INSTALL_FILES WRAPPER
       [ ] 225. Argparse tmp via mktemp
       [ ] 226. Cleaned on both success AND argparse error

  8.8  EXTERNAL COMMAND AUDIT
       [ ] 227. command -q preflight  [ ] 228. Failure handling
       [ ] 229. No version assumptions

  8.9  PRE-LOCK VALIDATION (v2.8.0)
       [ ] 230. Usage errors validated BEFORE _acquire_lock

  8.10 DISPATCH QUOTING (v2.8.0)
       [ ] 231. do_func "$TARGET" quoted (rg 'do_\w+ \$' → all quoted)

═══════════════════════════════════════════════════════════════
 PHASE 9: PATTERNS & ANTI-PATTERNS (15 checks)
═══════════════════════════════════════════════════════════════

  9.1  FALSE POSITIVES (do NOT flag)
       [ ] 232. "text"(command) — valid concat
       [ ] 233. Unquoted $ARRAY in for-loops — correct
       [ ] 234. $() inside awk/ExecStart — embedded bash
       [ ] 235. [[:class:]] inside grep -E — char class

  9.2  ANTI-PATTERNS
       [ ] 236. grep -q | ... (dead pipe)
       [ ] 237. cat file | grep (useless cat)
       [ ] 238. test "$var" = "" (use -z)
       [ ] 239. Bare find without command prefix
       [ ] 240. head -1 / tail -1 (use -n 1)
       [ ] 241. Nested substitution without clarity
       [ ] 242. REDIRECT BUG: string trim < "$file" 2>/dev/null on
               nonexistent files leaks stderr → use cat -- 2>/dev/null.
               RUNTIME-only test.

  9.3  STYLE
       [ ] 243. Consistent indentation  [ ] 244. Functions ≤50 lines
       [ ] 245. No dead code  [ ] 246. Comments explain WHY

═══════════════════════════════════════════════════════════════
 PHASE 10: MAGIC NUMBERS & DOCUMENTATION (19 checks)
═══════════════════════════════════════════════════════════════

  10.1 MAGIC NUMBERS
       [ ] 247. All numeric constants named  [ ] 248. Perms documented
       [ ] 249. Thresholds documented  [ ] 250. Timeouts documented
       [ ] 251. Hardware values documented  [ ] 252. 130 = SIGINT
       [ ] 253. TEMP_CPU_WARN/CRIT, TEMP_GPU_WARN/CRIT
       [ ] 254. DISK_ROOT_WARN/CRIT, BOOT_SPACE_WARN/CRIT
       [ ] 255. ROOT_AVAIL_CRIT/WARN (GB), NVME_LIFE_WARN (%)
       [ ] 256. MAX_LOGS, MAX_BACKUPS, CACHE_CLEAN_THRESHOLD
       [ ] 257. BOOT_TIME_WARN, BOOT_TIME_TARGET
       [ ] 258. WATCH_INTERVAL default

  10.2 DOCUMENTATION
       [ ] 259. --help covers all modes/flags
       [ ] 260. Inline comments for non-obvious decisions
       [ ] 261. Cross-refs noted  [ ] 262. Completions generated
       [ ] 263. README: quick-start, options, config ref
       [ ] 264. Changelog covers versions  [ ] 265. LICENSE present

═══════════════════════════════════════════════════════════════
 PHASE 11: TESTING & VALIDATION (23 checks)
═══════════════════════════════════════════════════════════════

  11.1 PREFLIGHT
       [ ] 266. Deps verified  [ ] 267. Disk space checked
       [ ] 268. Network verified  [ ] 269. HW fingerprint validated
       [ ] 270. Kernel version  [ ] 271. systemd version
       [ ] 272. Dep list accuracy (check_deps = actual usage, no stale)

  11.2 CONFIG VALIDATION
       [ ] 273. fish --no-execute on generated  [ ] 274. systemd-analyze verify
       [ ] 275. modprobe -n  [ ] 276. INI section headers
       [ ] 277. udev no empty match  [ ] 278. Hook order programmatic

  11.3 INTERNAL LINT
       [ ] 279. Version sync  [ ] 280. File/case counts
       [ ] 281. Anti-pattern self-scan  [ ] 282. Progress = actual

  11.4 DRY-RUN
       [ ] 283. All writes skipped  [ ] 284. Logged as DRY
       [ ] 285. Gates on ALL write paths

  11.5 ROLLBACK
       [ ] 286. Destructive ops have undo/dry-run
       [ ] 287. Backup before overwrite  [ ] 288. Recovery documented

═══════════════════════════════════════════════════════════════
 PHASE 12: RUNTIME EXECUTION (29 checks)
═══════════════════════════════════════════════════════════════

  Prerequisite: fish installed. Use PASS 3 harness above.

  12.1 STDOUT/STDERR SEPARATION
       [ ] 289. --help: stdout content, 0 stderr
       [ ] 290. --version: stdout version, 0 stderr
       [ ] 291. Op modes: all to stderr, 0 stdout
       [ ] 292. Errors: stderr only, 0 stdout

  12.2 EXIT CODE MATRIX
       [ ] 293. 0: --help, -h, --version, -v, --lint, --completions,
               --test-all, --logs list/system, --profile
       [ ] 294. 2: invalid flag, conflicts, modifier-only (--fix/--stress
               /--once alone), bad --interval, --install-file no path,
               --diff relative/path
       [ ] 295. 1: runtime failures (verify-static no sudo, etc.)
       [ ] 296. Modifier WARN (not exit 2): --interval/--json/--once
               without parent mode

  12.3 OPTION VALIDATION
       [ ] 297. Every flag accepted  [ ] 298. Modifier guards enforced
       [ ] 299. Multiple modes → exit 2  [ ] 300. -- stops parsing
       [ ] 301. --interval: missing/non-numeric/0/negative → exit 2
       [ ] 302. --install-file: no path → exit 2 (pre-lock)
       [ ] 303. --diff <path>: non-absolute → 2, non-managed → 1, valid → 0

  12.4 NO_COLOR
       [ ] 304. 0 ANSI escapes across ALL modes with --no-color.
               Includes do_watch clear-screen fallback to newlines (v2.8.3).

  12.5 DRY-RUN
       [ ] 305. [DRY] messages, 0 filesystem changes

  12.6 INTERNAL CONSISTENCY
       [ ] 306. --lint passes  [ ] 307. --test-all reports correctly
       [ ] 308. --logs no sub-target → exit 2
       [ ] 309. --logs analyze nonexistent → exit 1

  12.7 MODE-SPECIFIC
       [ ] 310. --watch non-tty → exit 1 + error on stderr
       [ ] 311. --no-log: no "Log file:", no .jsonl created
       [ ] 312. --diff <path>: shows single file diff
       [ ] 313. --no-log --version: clean exit 0

  12.8 --WATCH --ONCE (v2.8.0)
       [ ] 314. Non-tty: exits 0, dashboard output (tty gate relaxed)
       [ ] 315. Renders one frame then exits (no loop/prompt)
       [ ] 316. --once without --watch: WARN + resets (no exit 2)

  12.9 --PROFILE (v2.8.1)
       [ ] 325. [PROFILE] on stderr, NO_COLOR respected, absent when unset

  12.10 DO_WATCH ISATTY GUARD (v2.8.4)
       [ ] 326. Color output in do_watch gated by isatty 1 (not just
               NO_COLOR). Non-tty stdout suppresses ANSI escapes even
               without --no-color. Regression: rg 'isatty 1' do_watch.

═══════════════════════════════════════════════════════════════
 PHASE 13: GAP ANALYSIS & EDGE CASES (8 checks)
═══════════════════════════════════════════════════════════════

  Use PASS 4 data. Trace actual code paths.

  13.1 RACE CONDITIONS
       [ ] 317. mktemp O_EXCL, no check-use gap
       [ ] 318. No attacker substitution window (mktemp in target dir)

  13.2 ERROR PATH COMPLETENESS
       [ ] 319. Every tmpfile has cleanup on EVERY error branch
       [ ] 320. Credentials erased on every error path
       [ ] 321. Signal cleanup covers all tmpfile patterns (incl ry-argparse.*)

  13.3 LOGIC
       [ ] 322. DRY gates: every state-changing call through _run or explicit
               DRY check. Include do_watch — no writes in watch mode.

  13.4 EDGE CASES
       [ ] 323. do_watch: WATCH_COLS re-read each iteration, cleaned on exit

  13.5 LOCK REGRESSION (v2.8.2)
       [ ] 324. mkdir-only, 0 flock remnants, stale reclaim with --
               terminators, verify_pid race check present

═══════════════════════════════════════════════════════════════
 PASS 5: FINALIZE
═══════════════════════════════════════════════════════════════

STEP 1: COLLATE

  ```bash
  D=/home/claude/audit-data; O=/home/claude/audit-findings.txt
  test -s "$O" || echo "WARNING: No findings" > "$O"
  for sev in CRITICAL HIGH MED LOW INFO BUG STYLE; do
    echo "$sev: $(rg -c "^\[$sev\]" "$O" 2>/dev/null || echo 0)"
  done
  echo "TOTAL: $(rg -c '^(F-|\[)' "$O" 2>/dev/null || echo 0)"
  ```

STEP 2: SUMMARY TABLE

  Phase  | Checks | Pass | Fail | Info
  -------|--------|------|------|-----
  1      | 20     |      |      |
  2      | 18     |      |      |
  3      | 23     |      |      |
  4      | 24     |      |      |
  5      | 37     |      |      |
  6      | 47     |      |      |
  7      | 25     |      |      |
  8      | 37     |      |      |
  9      | 15     |      |      |
  10     | 19     |      |      |
  11     | 23     |      |      |
  12     | 30     |      |      |
  13     | 8      |      |      |
  TOTAL  | 326    |      |      |

  CRITICAL: N | HIGH: N | MED: N | LOW: N | INFO: N

  Notes:
  - 232-235: false-positive documentation, always PASS
  - Phase 12: REQUIRES fish execution
  - 296, 298: modifier-only → WARN not exit 2, verify at runtime
  - 242: redirect regression, RUNTIME only
  - 218, 324: lock regression, expect 0 flock hits
  - 325: --profile stderr + NO_COLOR
  - 326: do_watch isatty 1 color guard (v2.8.4 regression)

  Verdict: deploy-ready | fix-required | redesign-needed

  Partial: save findings, mark SKIPPED phases, add COVERAGE line,
  still produce spec, verdict "incomplete — N/13".

STEP 3: SPEC FILE

  SEVERITY: CRITICAL (data loss/security) | HIGH (functional bug) |
  MED (correctness) | LOW (style) | INFO (observation)

  Per finding: F-N | Severity | Phase | Checks | Lines | Category | Detail | Fix

  ```
  FIXES SPEC: <script> <old-ver> → <new-ver>
  Date: YYYY-MM-DD | Findings: N (N CRIT, N HIGH, N MED, N LOW, N INFO)

  --- FIX INSTRUCTIONS ---
  F-1  [SEV]  <summary>
       Checks: N,N  Lines: N,N  Category: <checklist item>
       Before: <exact text>
       After:  <exact replacement>
       Verify: <command>

  --- INFO (no action) ---
  I-1  [INFO]  <desc>  Checks: N  Lines: N

  --- VERSION ---
  Bump: <old> → <new>
  Changelog: v<new> <summary>.

  --- VERIFICATION ---
  1. fish --no-execute script.fish
  2. rg '<old-version>' script.fish README.md  (expect 0)
  3. rg '<new-version>' script.fish README.md  (expect N)
  ```

  Before/After must be exact. Spec self-contained. Version bump if any
  actionable fixes. INFO listed separately.

STEP 4: PACKAGE

  ```bash
  S=script; V=x.y.z; OUT=/mnt/user-data/outputs
  cp /home/claude/audit-${S}-${V}.txt /home/claude/fixes-spec-${V}.txt "$OUT/"
  cd /home/claude && zip "${OUT}/audit-${S}-${V}.zip" audit-${S}-${V}.txt fixes-spec-${V}.txt
  ```

DELIVERABLES: audit-<script>-<version>.txt + fixes-spec-<version>.txt (zipped)
