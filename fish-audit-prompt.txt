FISH SHELL SCRIPT AUDIT PROMPT
===============================
Version: 11.0.1
Derived from: ry-install.fish v3.2.5 audit (2026-02-28)
Changed: 11.0.1 Fix check 358 caller attribution (verify_runtime, not
               verify_static). Add PASS 4 gap traces for checks 363-365
               (dotfile glob, timestamp cache, string match separator
               regressions). Add -a --dry-run to check 293 exit 0 list.
               Add NO_COLOR loop comment re --diagnose --gaming.
         11.0.0 Sync v3.2.3→v3.2.5: SIGPIPE handler (_cleanup_pipe,
               exit 141, no stderr on broken pipe); _validate_kernel_params
               (cmdline vs /proc/config.gz CONFIG_ symbols); _preflight_boot
               _sanity (vmlinuz, initramfs, boot entry gate); _gather_temps
               sysfs rewrite (removes lm_sensors runtime dep); _diagnose
               _gaming extracted behind --gaming flag (--all auto-enables);
               dead global removal (MODULES_LOAD, _LOCK_METHOD); do_clean
               dotfile fix (find -mindepth 1 replaces glob); _log timestamp
               cache removed (direct date); string match -- separator fix in
               verify_runtime cmdline check. Phase 3: +1 check (314). Phase
               14: +9 checks (357-365). 362 checks (was 352).
         10.0.0 Sync v3.2.1→v3.2.3: footer double-write race fix
               (_FOOTER_WRITTEN before printf); log rotation race fix
               (_has_lock gate, write modes only); LC_ALL=C on backup
               and log rotation sorts; orphan log cleanup on 3 early
               exit paths (v3.2.2); --no-log orphan cleanup in signal/
               fish_exit handlers (v3.2.2). Fix header check count
               (was 350, actual 346 due to gaps 194/314-316).
               Phase 14: +6 checks (351-356). 352 checks (was 346).
         9.0.0 Sync v3.1.0→v3.2.1: /etc/sysctl.d/99-ry-sysctl.conf added,
         --json and --once flags removed
               (BBR+fq, tcp_fastopen=3, inotify); embedded files 16→17,
               system destinations 11→12; verify_static sysctl (4 _chk_grep);
               verify_runtime sysctl (/proc/sys reads); do_diagnose Sysctl
               Tuning section; sysctl --system reload in _install_configure
               and do_install_file; _install_finalize INSTALL_HAD_ERRORS
               propagation (v3.1.4); cat -- fixes (v3.1.4); --description
               on 77 functions (v3.1.2); 71 inline comments (v3.1.3).
               Phase 6: +3 checks (338-340); Phase 14: +10 checks (341-350).
               350 checks (was 337).
         8.0.0 Sync v3.0.0→v3.1.0: KVER globals; _ntsync_state helper (5
               states); _verify_unit_syntax, _check_service_active_enabled,
               _find_pacnew_files, _get_boot_time helpers; modules-load.d
               removed (17→16 files); sp5100_tco/btusb removed; kernel params
               19→18; power-profiles-daemon MASK not DEL; --existence-only
               hook validation; 11 new checks (327-337); #143 repurposed as
               regression. 337 checks (was 326).
         7.1.0 Sync v2.8.9→v3.0.0: fish_indent canonical formatting;
               README structured tables; changelog kernel.org style.
         7.0.0 Sync v2.8.3→v2.8.9: isatty 1 guard in do_watch (v2.8.4);
               comment/README trimming (v2.8.5-v2.8.9); 326 checks (was 325).
               Rewrite: consolidate passes, trim setup/explanations (~55% smaller).
         (Full history: 3.3.0→6.0.0 in git)
Checks: 362
Phases: 14 (11 static + 1 runtime + 1 gap analysis + 1 v3.1.0–v3.2.5 specifics)

PURPOSE
-------
362-check audit for production fish scripts managing system config,
sudo, credentials, embedded configs, and multi-mode dispatch with
backup/verification subsystems.

ZERO-SKIP: Every source line analyzed. No sampling. Trace all code
paths including error branches, unreachable code, early returns.

KEY LESSONS (encoded as checks):
  - Static analysis misses execution-order bugs → Phase 12
  - Fish redirects resolve BEFORE command runs → 242
  - Pre-lock validation: validate → lock → execute → 230
  - mkdir-only lock (no flock/exec fd since v2.8.2) → 218, 324
  - Dispatch args quoted → 231
  - Named constants for all thresholds → 247-258
  - check_deps matches actual usage → 272
  - --profile stderr + NO_COLOR → 325
  - do_watch isatty 1 color guard (v2.8.4) → 326
  - KVER globals centralize kernel version parsing → 327
  - _ntsync_state return-value function (stdout contract) → 328
  - Helper dedup: consolidated helpers replace inline code → 333
  - Removed features need regression checks → 334-336
  - sysctl.d complements vendor config without overlap → 340, 341
  - INSTALL_HAD_ERRORS must propagate to caller → 347
  - Footer flag-before-write prevents signal race → 353
  - Log rotation under lock prevents concurrent race → 354
  - LC_ALL=C on date-sorted filenames prevents locale bugs → 355, 356
  - Orphan log cleanup on every early exit path → 351, 352
  - SIGPIPE needs dedicated handler; Fish does not auto-ignore → 314, 357
  - Validate cmdline params against compiled kernel config → 358
  - Boot sanity gate prevents unbootable system after rebuild → 359
  - sysfs direct reads avoid forking external tools → 360
  - Extract optional diagnostics behind feature flags → 361
  - Dead globals are regression vectors → 362

───────────────────────────────────────────────────────────────
 SETUP
───────────────────────────────────────────────────────────────

STEP 0: COPY + TOOLS

  ```bash
  mkdir -p /home/claude/audit-{src,data}
  cp /mnt/user-data/uploads/<file> /home/claude/audit-src/script.fish
  wc -l /home/claude/audit-src/script.fish

  apt-get update -q 2>/dev/null && \
    apt-get install -y fish ripgrep fd-find bat 2>/dev/null; true
  for pair in "fdfind fd" "batcat bat"; do
    set -- $pair; src="$1" dst="$2"
    if command -v "$src" >/dev/null 2>&1 && ! command -v "$dst" >/dev/null 2>&1; then
      ln -sf "$(command -v "$src")" "/usr/local/bin/$dst"
    fi
  done
  for t in fish rg fd bat; do
    command -v "$t" >/dev/null 2>&1 && echo "$t: OK" || echo "$t: missing"
  done
  ```

  Fallbacks (if tools unavailable):
  ```bash
  command -v rg  >/dev/null 2>&1 || rg()  { grep -P --color=never "$@"; }
  command -v bat >/dev/null 2>&1 || bat() {
    local args=() range=""
    while [[ $# -gt 0 ]]; do
      case "$1" in --plain) shift ;; -r) shift; range="$1"; shift ;; *) args+=("$1"); shift ;; esac
    done
    if [[ -n "$range" ]]; then sed -n "${range%%:*},${range##*:}p" "${args[-1]}"; else cat "${args[@]}"; fi
  }
  command -v fd  >/dev/null 2>&1 || fd() { local pat="$1"; shift; find "$@" -name "$pat" 2>/dev/null; }
  command -v sd  >/dev/null 2>&1 || sd() { sed -i "s/$1/$2/g" "${@:3}"; }
  export -f rg bat fd sd 2>/dev/null; true
  ```

FISH SYNTAX (auditor reference):
  $var (not ${var}) · (command) (not $(command)) · test/string (not [[]])
  set -gx (not export) · ; and / ; or (not &&/||) · set --erase (not set -e)
  for x in $ARRAY unquoted · "text"(cmd) is valid concat · -- before args
  read -P "prompt: " var · read -sP for hidden input
  REDIRECT BUG: < nonexistent 2>/dev/null leaks warnings → use cat -- 2>/dev/null

CONFIG SYNTAX: see userPreferences [AUDIT] section
CROSS-REFS: see userPreferences [AUDIT] cross_refs

───────────────────────────────────────────────────────────────
 EXECUTION
───────────────────────────────────────────────────────────────

RULES: Work continuously. Batch tool calls. Parallel when independent.
  >60 lines output → file first. >3 calls with no findings → flush.
  Blocked → DEFERRED, continue. Save after EVERY pass. Max 3 retries.
  Never re-read same region twice. >10 items → sub-chunks of 5.
  Write findings: echo "F-N ..." >> /home/claude/audit-findings.txt

ORDER:
  PASS 1 — DATA GATHER    phases 1-11,14  (compound parallel commands)
  PASS 2 — STATIC         phases 1-11,14  (analyze gathered data)
  PASS 3 — RUNTIME        phase 12        (fish execution tests)
  PASS 4 — GAP ANALYSIS   phase 13        (race/error/edge tracing)
  PASS 5 — FINALIZE       —               (summary + spec + zip)

PASS 1: DATA GATHERING (single compound block)

  ```bash
  F=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data
  mkdir -p "$D"

  # P1-5: syntax, routing, errors, vars, security
  (
    echo "=== BASHISMS ==="
    rg -n '\$\(|export |&&|\|\||set -e |\$\{|functions -e|unset |local ' "$F"
    echo "=== STRING OPS ==="
    rg -n 'string (match|replace|split|join|trim)' "$F" | rg -v -- '--'
    echo "=== ARGPARSE ===" && rg -n 'argparse|argv' "$F"
    echo "=== ROUTING ===" && rg -n '>&2|>/dev/null|stderr|stdout' "$F"
    echo "=== NO_COLOR ===" && rg -n 'NO_COLOR|isatty|tput|test -t' "$F"
    echo "=== EXIT/RETURN ===" && rg -n 'exit [0-9]|return [0-9]|exit$' "$F"
    echo "=== STATUS ===" && rg -n '\$status|\$pipestatus' "$F"
    echo "=== SIGNALS ===" && rg -n 'trap|--on-signal|--on-event|fish_exit' "$F"
    echo "=== CLEANUP ===" && rg -n 'mktemp|rm -f|rm -rf|cleanup|_do_cleanup' "$F"
    echo "=== SCOPE ===" && rg -n 'set -[glx]|set --erase|set --global|set --local' "$F"
    echo "=== FOR LOOPS ===" && rg -n 'for .* in ' "$F"
    echo "=== INJECTION ===" && rg -n 'eval|source ' "$F"
    echo "=== CREDS ===" && rg -ni 'password|passphrase|credential|secret|WIFI_PASS' "$F"
    echo "=== PERMS ===" && rg -n 'chmod|chown|0600|0644|0700|0755' "$F"
    echo "=== SUDO ===" && rg -n 'sudo |_IS_ROOT' "$F"
    echo "=== EXT CMDS ===" && rg -n 'command -q|command -v' "$F"
  ) > "$D/p1-5.txt" 2>&1 &

  # P6-7: embedded configs, cross-refs
  (
    echo "=== CONFIG FORMATS ===" && rg -n '\[Unit\]|\[Service\]|\[Install\]' "$F"
    echo "=== SYSTEMD ===" && rg -n 'ExecStart|After=|Type=' "$F"
    echo "=== UDEV ===" && rg -n 'ACTION==|SUBSYSTEM==|ATTR{' "$F"
    echo "=== DESTINATIONS ===" && rg -n 'SERVICE_DESTINATIONS|amdgpu-performance|cpupower-epp' "$F"
    echo "=== SDBOOT ===" && rg -n 'LINUX_FALLBACK_OPTIONS|SDBOOT' "$F"
    echo "=== VERSION ===" && rg -n 'VERSION|SYSTEM_DEST|USER_DEST|SERVICE_DEST|get_file_content|MASK' "$F"
    echo "=== DISPATCH ===" && rg -n 'do_\w+ \$|do_\w+ "\$' "$F" | rg -v 'function |#|_log'
    echo "=== WATCH ===" && rg -n 'WATCH_INTERVAL|do_watch|--watch' "$F"
    echo "=== PROFILE ===" && rg -n 'PROFILE|profile' "$F"
    echo "=== SYSCTL ===" && rg -n 'sysctl|BBR|tcp_fastopen|default_qdisc|inotify' "$F"
  ) > "$D/p6-7.txt" 2>&1 &

  # P8-11: architecture, patterns, docs, testing
  (
    echo "=== FUNCTIONS ===" && rg -n '^function |^end$' "$F"
    echo "=== ARITY ===" && rg -n 'count \$argv|test .* -ne |test .* -lt ' "$F"
    echo "=== ATOMIC ===" && rg -n 'mv |install_file|chmod.*mv' "$F"
    echo "=== LOCK ===" && rg -n 'mkdir.*lock|rmdir.*lock|kill -0|LOCK|flock|exec 9' "$F"
    echo "=== LOG ===" && rg -n '_log|_json_str|NDJSON|log_file|\.jsonl' "$F"
    echo "=== BACKUP ===" && rg -n '_backup_|BACKUP_BASE|BACKUP_DIR|MAX_BACKUPS' "$F"
    echo "=== ARGPARSE TMP ===" && rg -n 'ry-argparse|_argparse_tmp' "$F"
    echo "=== ANTIPATTERNS ===" && rg -n 'cat .* \| |test .* = ""|head -1|tail -1' "$F"
    echo "=== REDIRECT BUG ===" && rg -n 'string trim.*<|string match.*<' "$F" | rg -v '#'
    echo "=== MAGIC NUMS ===" && rg -n 'TEMP_|DISK_|BOOT_|MAX_|CACHE_|ROOT_AVAIL|NVME_LIFE|WATCH_INTERVAL' "$F"
    echo "=== DRY ===" && rg -n 'DRY|dry.run|--dry-run|\[DRY\]' "$F"
    echo "=== TEST_ALL ===" && rg -n 'do_test_all|verify.static|verify.runtime' "$F"
    echo "=== ISATTY ===" && rg -n 'isatty|test -t' "$F"
    echo "=== ROLLBACK ===" && rg -n 'rollback|undo|revert|restore|_backup' "$F"
    echo "=== PRE-LOCK ===" && rg -n 'case install-file|case install|_acquire_lock' "$F"
  ) > "$D/p8-11.txt" 2>&1 &

  # P14: v3.1.0–v3.2.5 helpers, regressions, sysctl, race fixes, SIGPIPE, boot sanity
  (
    echo "=== KVER GLOBALS ===" && rg -n 'KVER|KVER_MAJOR|KVER_MINOR' "$F"
    echo "=== _ntsync_state ===" && rg -n '_ntsync_state' "$F"
    echo "=== _verify_unit_syntax ===" && rg -n '_verify_unit_syntax' "$F"
    echo "=== _check_service_active ===" && rg -n '_check_service_active' "$F"
    echo "=== _find_pacnew ===" && rg -n '_find_pacnew' "$F"
    echo "=== _get_boot_time ===" && rg -n '_get_boot_time' "$F"
    echo "=== EXISTENCE_ONLY ===" && rg -n 'existence.only' "$F"
    echo "=== MODULES-LOAD REGRESSION ===" && rg -n 'modules-load' "$F"
    echo "=== SP5100_TCO REGRESSION ===" && rg -ni 'sp5100' "$F"
    echo "=== BTUSB REGRESSION ===" && rg -ni 'btusb|enable_autosuspend' "$F"
    echo "=== PPD REGRESSION ===" && rg -n 'power-profiles-daemon' "$F"
    echo "=== MODPROBE_BLACKLIST ===" && rg -n 'MODPROBE_BLACKLIST' "$F"
    echo "=== HELPER BODIES ===" && rg -n '^function _ntsync_state|^function _verify_unit|^function _check_service|^function _find_pacnew|^function _get_boot_time' "$F"
    echo "=== UNAME INLINE ===" && rg -n 'uname -r' "$F" | rg -v 'KVER|#'
    echo "=== SYSCTL DEST ===" && rg -n 'sysctl.d' "$F"
    echo "=== SYSCTL CONTENT ===" && rg -n 'default_qdisc|tcp_congestion|tcp_fastopen|max_user_watches' "$F"
    echo "=== SYSCTL RELOAD ===" && rg -n 'sysctl --system' "$F"
    echo "=== SYSCTL VERIFY ===" && rg -n '_chk_grep.*/etc/sysctl' "$F"
    echo "=== SYSCTL RUNTIME ===" && rg -n '/proc/sys/' "$F"
    echo "=== SYSCTL DIAGNOSE ===" && rg -n '_diag_sysctl|Sysctl Tuning' "$F"
    echo "=== INSTALL_HAD_ERRORS ===" && rg -n 'INSTALL_HAD_ERRORS' "$F"
    echo "=== CAT TERMINATOR ===" && rg -n 'cat --' "$F" | head -20
    echo "=== FUNCTION DESCRIPTIONS ===" && rg -c -- '--description' "$F"
    echo "=== FUNCTION COUNT ===" && rg -c '^function ' "$F"
    echo "=== VENDOR OVERLAP ===" && rg -n '70-cachyos-settings' "$F"
    echo "=== FOOTER RACE ===" && rg -n '_FOOTER_WRITTEN' "$F"
    echo "=== LOG ROTATION LOCK ===" && rg -n '_has_lock|Log rotation' "$F"
    echo "=== LC_ALL SORT ===" && rg -n 'LC_ALL=C sort' "$F"
    echo "=== ORPHAN LOG ===" && rg -n 'LOG_FILE.*rm|rm.*LOG_FILE|install-.*jsonl' "$F" | head -20
    echo "=== EARLY EXIT LOG ===" && rg -n 'exit 2' "$F" | head -20
    echo "=== SIGPIPE HANDLER ===" && rg -n '_cleanup_pipe|SIGPIPE|on-signal PIPE|exit 141' "$F"
    echo "=== VALIDATE KERNEL PARAMS ===" && rg -n '_validate_kernel_params|param_config_map|/proc/config.gz' "$F"
    echo "=== BOOT SANITY ===" && rg -n '_preflight_boot_sanity|vmlinuz|initramfs.*non.zero' "$F"
    echo "=== GATHER TEMPS ===" && rg -n '_gather_temps|lm_sensors' "$F"
    echo "=== GAMING FLAG ===" && rg -n 'GAMING|--gaming|_diagnose_gaming' "$F"
    echo "=== DEAD GLOBALS ===" && rg -n 'MODULES_LOAD|_LOCK_METHOD' "$F"
    echo "=== DOTFILE CLEAN ===" && rg -n 'mindepth 1.*exec|find.*mindepth.*rm' "$F"
    echo "=== LOG TIMESTAMP ===" && rg -n '_TS_CACHE|/proc/uptime' "$F"
    echo "=== STRING MATCH SEPARATOR ===" && rg -n "string match.*' -- '" "$F"
  ) > "$D/p14.txt" 2>&1 &

  wait
  wc -l "$D"/*.txt
  ```

PASS 3: RUNTIME (phase 12)

  ```bash
  S=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data/runtime
  mkdir -p "$D"

  # stdout/stderr separation
  fish "$S" --help    >"$D/help-out.txt"  2>"$D/help-err.txt"  &
  fish "$S" -h        >"$D/h-out.txt"     2>"$D/h-err.txt"     &
  fish "$S" --version >"$D/ver-out.txt"   2>"$D/ver-err.txt"   &
  fish "$S" -v        >"$D/v-out.txt"     2>"$D/v-err.txt"     &
  wait

  # exit code matrix
  for mode in \
    "--help" "-h" "--version" "-v" "--bogus" "--fix" "--stress" \
    "--diff --lint" "--interval" "--interval abc" "--interval 0" "--interval -5" \
    "--verify-static" "--verify-runtime" "--lint" "--test-all" \
    "--clean --dry-run" "--completions" "--diff" "--diagnose" \
    "--install-file" "--install-file /etc/kernel/cmdline --dry-run" \
    "--logs" "--logs list" "--logs system" "--logs analyze" \
    "--watch" \
    "--no-log --version" "--no-log --lint" \
    "--diff /etc/kernel/cmdline" "--diff relative/path" \
    "--diff /etc/sysctl.d/99-ry-sysctl.conf" \
    "--profile --dry-run" \
    "--dry-run" "-n" "--all --dry-run" "-a --dry-run" \
    "--verbose --dry-run" "-V --dry-run" "--force --dry-run" "-f --dry-run" \
    "--no-color --dry-run" \
    "--gaming" "--diagnose --gaming" "--diagnose --gaming --dry-run" \
    "--all --diagnose --dry-run"; do
    fish "$S" $mode >/dev/null 2>&1
    printf '%s → %d\n' "$mode" "$?" >> "$D/exit-codes.txt"
  done

  # --profile timing
  fish "$S" --dry-run --profile --no-color >"$D/profile-out.txt" 2>"$D/profile-err.txt"
  fish "$S" --dry-run --no-color >"$D/noprofile-out.txt" 2>"$D/noprofile-err.txt"

  # --watch non-tty (expect exit 1)
  echo "" | fish "$S" --watch >"$D/watch-notty-out.txt" 2>"$D/watch-notty-err.txt"
  printf '--watch non-tty → %d\n' "$?" >> "$D/exit-codes.txt"

  # SIGPIPE handling (expect exit 141)
  fish "$S" --lint 2>&1 | head -1 >/dev/null 2>&1
  printf '--lint|head -1 → %d\n' "${PIPESTATUS[0]}" >> "$D/exit-codes.txt"

  # NO_COLOR enforcement (--diagnose --gaming runs real checks; acceptable on audit container)
  for mode in "--lint" "--diff" "--dry-run" "--diagnose" "--logs list" "--diagnose --gaming"; do
    NO_COLOR=1 fish "$S" $mode --no-color 2>"$D/nocolor-$mode.txt" >/dev/null &
  done
  wait

  # DRY-RUN filesystem safety
  stat -c '%n %Y' /etc/modprobe.d/* 2>/dev/null | sort > "$D/pre-dry.txt"
  fish "$S" --dry-run >"$D/dry-out.txt" 2>"$D/dry-err.txt"
  stat -c '%n %Y' /etc/modprobe.d/* 2>/dev/null | sort > "$D/post-dry.txt"
  diff "$D/pre-dry.txt" "$D/post-dry.txt" > "$D/dry-diff.txt"

  # Misc
  fish "$S" --lint >"$D/lint-out.txt" 2>"$D/lint-err.txt"
  fish "$S" --no-log --version >"$D/nolog-out.txt" 2>"$D/nolog-err.txt"
  rg 'Log file:' "$D/nolog-err.txt" > "$D/nolog-check.txt" 2>/dev/null

  # Fish redirect regression
  fish -c '
    set result (string trim -- (cat -- /nonexistent/path 2>/dev/null))
    echo "result: [$result]"
  ' >"$D/redirect-out.txt" 2>"$D/redirect-err.txt"

  # --help exit code coverage (must document 141)
  rg '141' "$D/help-out.txt" > "$D/help-141.txt" 2>/dev/null

  # --gaming flag validation
  fish "$S" --gaming 2>"$D/gaming-alone-err.txt" >/dev/null
  printf '--gaming alone → %d\n' "$?" >> "$D/exit-codes.txt"
  rg -i 'warn|ignor' "$D/gaming-alone-err.txt" > "$D/gaming-warn.txt" 2>/dev/null

  # Analyze
  echo "=== STDERR BYTES (expect 0 for help/version) ===" && wc -c "$D"/{help,h,ver,v}-err.txt
  echo "=== EXIT CODES ===" && bat --plain "$D/exit-codes.txt"
  echo "=== ANSI (expect 0) ===" && rg -cP '\x1b\[' "$D"/nocolor-*.txt 2>/dev/null || echo "none"
  echo "=== DRY-RUN FS (expect empty) ===" && bat --plain "$D/dry-diff.txt"
  echo "=== LINT ===" && bat --plain "$D/lint-err.txt"
  echo "=== NO-LOG (expect empty) ===" && bat --plain "$D/nolog-check.txt"
  echo "=== WATCH NON-TTY ===" && bat --plain "$D/watch-notty-err.txt"
  echo "=== REDIRECT ===" && bat --plain "$D/redirect-err.txt"
  echo "=== PROFILE ===" && rg -c '\[PROFILE\]' "$D/profile-err.txt" 2>/dev/null || echo "0"
  echo "=== NO PROFILE (expect 0) ===" && rg -c '\[PROFILE\]' "$D/noprofile-err.txt" 2>/dev/null || echo "0"
  echo "=== HELP 141 (expect 1 hit) ===" && bat --plain "$D/help-141.txt"
  echo "=== GAMING WARN ===" && bat --plain "$D/gaming-warn.txt"
  ```

PASS 4: GAP ANALYSIS (phase 13)

  ```bash
  F=/home/claude/audit-src/script.fish
  D=/home/claude/audit-data

  # Tmpfile lifecycle per function
  for func in $(rg -oP '(?<=^function )\w+' "$F" | sort -u); do
    if rg -A 50 "^function $func" "$F" | rg -q 'mktemp'; then
      echo "--- $func ---"
      rg -A 50 "^function $func" "$F" | rg 'mktemp|rm -f|return|set --erase'
    fi
  done > "$D/gap-tmpfile.txt"

  # DRY-RUN gate coverage
  rg -n 'sudo |pacman |systemctl |mv |tee ' "$F" | rg -v 'DRY|_run|#|echo|rg|string' > "$D/gap-dry.txt"

  # Lock regression (expect 0 flock hits)
  rg -n 'flock|exec 9|_LOCK_METHOD.*flock' "$F" > "$D/gap-lock-regression.txt"
  rg -n 'mkdir.*LOCK|rmdir.*LOCK|verify_pid' "$F" > "$D/gap-lock-trace.txt"

  # Argparse temp lifecycle
  rg -n 'ry-argparse|_argparse_tmp' "$F" > "$D/gap-argparse.txt"

  # sysctl reload coverage
  rg -n 'sysctl --system' "$F" > "$D/gap-sysctl-reload.txt"

  # INSTALL_HAD_ERRORS propagation
  rg -n 'INSTALL_HAD_ERRORS' "$F" > "$D/gap-install-errors.txt"

  # Footer race: flag must be BEFORE printf
  rg -n '_FOOTER_WRITTEN' "$F" > "$D/gap-footer-race.txt"

  # Log rotation lock gate
  rg -n '_has_lock' "$F" > "$D/gap-rotation-lock.txt"

  # LC_ALL=C sort for date-ordered files
  rg -n 'sort' "$F" | rg -v '#|sort -' > "$D/gap-sort-locale.txt"

  # SIGPIPE cleanup completeness: _cleanup_pipe must call _do_cleanup
  rg -A 15 '^function _cleanup_pipe' "$F" > "$D/gap-sigpipe.txt"

  # Boot sanity gate: called after rebuild, before declaring success
  rg -n '_preflight_boot_sanity' "$F" > "$D/gap-boot-sanity.txt"

  # _validate_kernel_params: called in verify flow
  rg -n '_validate_kernel_params' "$F" > "$D/gap-validate-kernel.txt"

  # Dead global regression (expect 0 hits)
  rg -n 'MODULES_LOAD\b|_LOCK_METHOD\b' "$F" > "$D/gap-dead-globals.txt"

  # Dotfile glob regression (expect 0 rm -rf "$d"/* in do_clean)
  rg -n 'rm -rf.*\*' "$F" | rg -v '#' > "$D/gap-dotfile-glob.txt"

  # Timestamp cache regression (expect 0 hits)
  rg -n '_TS_CACHE|/proc/uptime' "$F" > "$D/gap-ts-cache.txt"

  # String match separator regression
  rg -n "string match.*'.*--.*'" "$F" | rg -v '#' > "$D/gap-string-separator.txt"

  wc -l "$D"/gap-*.txt
  ```

───────────────────────────────────────────────────────────────
 PHASE CHECKLIST
───────────────────────────────────────────────────────────────

═══════════════════════════════════════════════════════════════
 PHASE 1: FISH SHELL COMPLIANCE (20 checks)
═══════════════════════════════════════════════════════════════

  Exempt: Hits in embedded content (ExecStart, awk, heredocs, lint
  self-checkers) are NOT findings.

  1.1  BASHISMS
       [ ] 1. $()  [ ] 2. [[]]  [ ] 3. export  [ ] 4. &&/||
       [ ] 5. ${var}  [ ] 6. set -e VAR  [ ] 7. functions -e
       [ ] 8. unset  [ ] 9. source (verify correct usage)  [ ] 10. local

  1.2  VERSION GATE
       [ ] 11. Fish version checked before executing
       [ ] 12. Minimum version matches features used

  1.3  STRING OPS
       [ ] 13. -- separator before arguments
       [ ] 14. No sed/awk/grep where string builtins suffice
       [ ] 15. string match uses -q for boolean tests

  1.4  OPTION PARSING
       [ ] 16. argparse used  [ ] 17. Unknown opts → error + usage
       [ ] 18. -- handled

  1.5  SYNTAX VALIDATION
       [ ] 19. fish --no-execute passes  [ ] 20. Embedded fish valid

═══════════════════════════════════════════════════════════════
 PHASE 2: STDERR / STDOUT ROUTING (18 checks)
═══════════════════════════════════════════════════════════════

  2.1  OUTPUT CONTRACT
       [ ] 21. Diagnostics → stderr  [ ] 22. Machine data → stdout
       [ ] 23. --help → stdout  [ ] 24. --version → stdout
       [ ] 25. Errors → stderr  [ ] 26. --help: 0 stderr bytes
       [ ] 27. --version: 0 stderr bytes
       [ ] 28. Bad option: help to stderr, 0 stdout bytes

  2.2  MESSAGE FUNCTIONS
       [ ] 29. Central _msg routes to stderr
       [ ] 30. NO_COLOR env respected  [ ] 31. --no-color flag respected
       [ ] 32. isatty check (test -t 2)
       [ ] 33. Levels consistent (ok/fail/info/warn/err/dry)

  2.3  COMMAND OUTPUT
       [ ] 34. Wrapped stdout preserved  [ ] 35. Wrapped stderr captured
       [ ] 36. Quiet mode suppresses stdout  [ ] 37. Verbose shows detail

  2.4  EXECUTION ORDER
       [ ] 38. Root check/env setup silent before --help/--version parse

═══════════════════════════════════════════════════════════════
 PHASE 3: ERROR HANDLING & EXIT CODES (24 checks)
═══════════════════════════════════════════════════════════════

  3.1  EXIT CODES
       [ ] 39. 0: success/help/version  [ ] 40. 1: runtime errors
       [ ] 41. 2: usage errors  [ ] 42. 130: SIGINT (128+2), 141: SIGPIPE (128+13)
       [ ] 43. Functions use return not exit
       [ ] 44. No bare exit without code  [ ] 45. No exit inside functions

  3.2  STATUS CAPTURE
       [ ] 46. $status captured immediately  [ ] 47. $pipestatus for pipes
       [ ] 48. Not clobbered by _log/_msg  [ ] 49. No intervening calls

  3.3  SIGNAL HANDLERS
       [ ] 50. INT  [ ] 51. TERM  [ ] 52. HUP  [ ] 53. fish_exit
       [ ] 314. PIPE (v3.2.5: _cleanup_pipe, exit 141, no stderr on broken pipe)
       [ ] 54. Handlers don't mask exit code

  3.4  CLEANUP GUARANTEE
       [ ] 55. Temp files  [ ] 56. Lock files  [ ] 57. Background procs
       [ ] 58. Credentials erased  [ ] 59. Sudo keepalive terminated
       [ ] 60. Cleanup idempotent  [ ] 61. UID-scoped /tmp sweep

═══════════════════════════════════════════════════════════════
 PHASE 4: VARIABLE HANDLING (24 checks)
═══════════════════════════════════════════════════════════════

  4.1  SCOPE
       [ ] 62. Globals: set -g  [ ] 63. Locals: set -l
       [ ] 64. Exports: set -gx  [ ] 65. No scope leaks
       [ ] 66. Loop vars scoped  [ ] 67. No top-level set without flag

  4.2  set --erase AUDIT
       [ ] 68. Modern syntax (not set -e)  [ ] 69. No unnecessary 2>/dev/null
       [ ] 70. Creds erased on ALL paths  [ ] 71. Consistent style

  4.3  FOR-LOOP VARIABLES
       [ ] 72. Unquoted: for x in $ARRAY  [ ] 73. Never "for x in "$ARRAY""
       [ ] 74. Empty array safe

  4.4  UNNECESSARY REDIRECTS ON BUILTINS
       [ ] 75. No 2>/dev/null on set  [ ] 76. No 2>/dev/null on command -q
       [ ] 77. OK on set -l var (external-cmd) — suppresses cmd stderr

  4.5  NAMING
       [ ] 78. UPPER_SNAKE user globals  [ ] 79. _UPPER internal globals
       [ ] 80. lower_snake locals  [ ] 81. Functions lowercase+underscore
       [ ] 82. No single-letter outside tight loops  [ ] 83. Flag if found

  4.6  QUOTING
       [ ] 84. Vars quoted in test/string  [ ] 85. Paths always quoted

═══════════════════════════════════════════════════════════════
 PHASE 5: SECURITY (37 checks)
═══════════════════════════════════════════════════════════════

  5.1  COMMAND INJECTION
       [ ] 86. No eval  [ ] 87. Input validated  [ ] 88. -- separators
       [ ] 89. No unchecked interpolation  [ ] 90. No var-as-command
       [ ] 91. Only $argv in _run-style wrappers

  5.2  TEMP FILES
       [ ] 92. mktemp  [ ] 93. TOCTOU mitigated  [ ] 94. mktemp fail handled
       [ ] 95. Cleaned on all paths  [ ] 96. UID-owned  [ ] 97. Unique prefix
       [ ] 98. No predictable names in /tmp

  5.3  CREDENTIAL HANDLING
       [ ] 99. read -s  [ ] 100. Erased after use  [ ] 101. Redacted in logs
       [ ] 102. 0600 perms  [ ] 103. Not in CLI args  [ ] 104. Not exported
       [ ] 105. Special chars escaped

  5.4  FILE PERMISSIONS
       [ ] 106. System: 644  [ ] 107. User: 600  [ ] 108. Creds: 600
       [ ] 109. Logs: 600  [ ] 110. Backup dirs: 700
       [ ] 111. chmod before mv

  5.5  PRIVILEGE SEPARATION
       [ ] 112. Root warning/abort  [ ] 113. Root → forced dry-run
       [ ] 114. sudo least privilege  [ ] 115. Keepalive lifecycle
       [ ] 116. Restricted sudo handled

  5.6  INPUT VALIDATION
       [ ] 117. Interface names  [ ] 118. SSIDs (1-32, no metachar, no %)
       [ ] 119. Passphrases (8-63, no newlines)  [ ] 120. Country codes
       [ ] 121. Paths (canonical, no traversal)  [ ] 122. Numeric ranges

═══════════════════════════════════════════════════════════════
 PHASE 6: EMBEDDED CONFIG CONTENT (50 checks)
═══════════════════════════════════════════════════════════════

  3 arrays: SYSTEM (12), USER (3), SERVICE (2) = 17 files.

  6.1  SYSTEMD-BOOT
       [ ] 123. key<space>value (no =)  [ ] 124. Valid keys only

  6.2  KERNEL CMDLINE
       [ ] 125. rw root=UUID=<uuid>  [ ] 126. UUID dynamic
       [ ] 127. Space-separated, no trailing ws
       [ ] 128. modprobe.d blacklist-only (no options since v2.5.0)

  6.3  SDBOOT-MANAGE
       [ ] 129. KEY="VALUE"  [ ] 130. Required keys present
       [ ] 131. FALLBACK="quiet"  [ ] 132. OPTIONS ⊇ KERNEL_PARAMS

  6.4  MKINITCPIO
       [ ] 133. MODULES=() HOOKS=() COMPRESSION=""
       [ ] 134. base first  [ ] 135. systemd before sd-vconsole
       [ ] 136. keyboard before sd-vconsole  [ ] 137. filesystems before fsck
       [ ] 138. Modules validated via modprobe -n

  6.5  MODPROBE
       [ ] 139. No "options" lines (regression)  [ ] 140. blacklist format
       [ ] 141. Modules validated  [ ] 142. Cross-ref with cmdline

  6.6  MODULES-LOAD REGRESSION (v3.1.0)
       [ ] 143. No modules-load.d destinations, no dead code paths.
               CachyOS vendor ships /usr/lib/modules-load.d/ntsync.conf.
               Expect: 0 hits for modules-load.d in DESTINATIONS arrays.
               Expect: only comment references (no functional code).

  6.7  UDEV
       [ ] 144. == for match  [ ] 145. = for assign
       [ ] 146. ATTR{} correct  [ ] 147. No empty match values

  6.8  SYSTEMD UNITS
       [ ] 148. [Unit] [Service] [Install]  [ ] 149. After= correct
       [ ] 150. ExecStart absolute paths  [ ] 151. systemd-analyze verify
       [ ] 152. Type= matches behavior
       [ ] 153. amdgpu-performance: bash -c, retry, /sys/class/drm, graphical.target
       [ ] 154. cpupower-epp: bash -c, EPP path, After=cpupower, multi-user, Timeout

  6.9  DROP-INS
       [ ] 155. No journald.conf.d (removed v2.5.0, regression)
       [ ] 156. No coredump.conf.d (removed v2.5.0, regression)
       [ ] 157. resolved: [Resolve] not [Resolved]
       [ ] 158. logind: [Login] section

  6.10 IWD
       [ ] 159. [General] [DriverQuirks] [Network]  [ ] 160. Valid keys

  6.11 NETWORKMANAGER
       [ ] 161. [device] [connection] [logging]
       [ ] 162. wifi.powersave correct  [ ] 163. wifi.backend matches

  6.12 WIRELESS-REGDOM
       [ ] 164. WIRELESS_REGDOM="XX"

  6.13 ENVIRONMENT.D
       [ ] 165. KEY=VALUE (no export/quotes)  [ ] 166. XDG_RUNTIME_DIR

  6.14 FISH CONFIGS
       [ ] 167. fish --no-execute valid  [ ] 168. Guards present
       [ ] 169. SSH auth sock priority (forwarded > gcr > systemd)

  6.15 SYSCTL.D (v3.2.0)
       [ ] 338. key = value format (spaces around =), comment header
               references CachyOS vendor 70-cachyos-settings.conf
       [ ] 339. No overlap with CachyOS vendor sysctl; only keys NOT
               in 70-cachyos-settings.conf (BBR, fq, tcp_fastopen, inotify)
       [ ] 340. 4 required keys present: net.core.default_qdisc = fq,
               net.ipv4.tcp_congestion_control = bbr,
               net.ipv4.tcp_fastopen = 3,
               fs.inotify.max_user_watches = 524288

═══════════════════════════════════════════════════════════════
 PHASE 7: CROSS-REFERENCES & CONSISTENCY (24 checks)
═══════════════════════════════════════════════════════════════

  7.1  VERSION SYNC
       [ ] 170. Header = global  [ ] 171. Global = README
       [ ] 172. Changelog entry exists  [ ] 173. Lint verifies auto

  7.2  FILE COUNTS
       [ ] 174. SYSTEM count = 12, get_file_content system cases = 12
       [ ] 175. USER count = 3, get_file_content glob cases = 3
       [ ] 176. SERVICE count = 2, get_file_content service cases = 2
       [ ] 177. Progress steps = actual calls
       [ ] 178. README count = 17 total  [ ] 179. '*' fallback returns 1

  7.3  PARAMETER CROSS-REFS
       [ ] 180. modprobe.d blacklist-only (regression)
       [ ] 181. MKINITCPIO_MODULES match hardware
       [ ] 182. Blacklist consistent cmdline↔modprobe
       [ ] 183. ENV_VARS match environment.d↔runtime verify

  7.4  README ↔ HELP
       [ ] 184. All --help options in README
       [ ] 185. Sub-options documented (--diff --fix, --diagnose --stress,
               --diagnose --gaming, etc.)
       [ ] 186. Modifiers as separate entries (--fix, --stress, --gaming, etc.)
       [ ] 187. --logs sub-targets documented
       [ ] 188. --install-file documented  [ ] 189. Exit codes documented
               (must include 0, 1, 2, 130, 141 in both --help and README)
       [ ] 190. Prerequisites listed

  7.5  MODE CROSS-REFS
       [ ] 191. --watch + --interval in README  [ ] 192. --no-log in README
       [ ] 193. --profile in README

═══════════════════════════════════════════════════════════════
 PHASE 8: FUNCTION ARCHITECTURE (37 checks)
═══════════════════════════════════════════════════════════════

  8.1  ARITY
       [ ] 195. Count validated at entry  [ ] 196. Error messages show counts
       [ ] 197. Return 1 on error (not exit)

  8.2  ATOMIC FILE OPS
       [ ] 198. Write to tmp first  [ ] 199. Perms before mv
       [ ] 200. Atomic mv (same fs)  [ ] 201. Symlink detection
       [ ] 202. Owner/group correct

  8.3  IDEMPOTENCY
       [ ] 203. Re-run identical  [ ] 204. Diff-before-write skip
       [ ] 205. pacman --needed  [ ] 206. Service enable idempotent

  8.4  LOGGING
       [ ] 207. JSONL format  [ ] 208. Timestamps  [ ] 209. Sensitive redacted
       [ ] 210. MAX_LOGS rotation  [ ] 211. Log perms 0600
       [ ] 212. _json_str escaping

  8.5  LOCK FILE
       [ ] 213. Prevents concurrent  [ ] 214. mkdir-only (since v2.8.2)
       [ ] 215. Stale reclaim (kill -0 + find + rmdir + re-mkdir)
       [ ] 216. Cleaned on all paths  [ ] 217. PID in lock dir
       [ ] 218. REGRESSION: rg 'flock|exec 9|_LOCK_METHOD.*flock' → 0 hits

  8.6  BACKUP
       [ ] 219. _backup_init dated dir  [ ] 220. _backup_path preserves structure
       [ ] 221. _backup_boot flat /boot  [ ] 222. MAX_BACKUPS rotation
       [ ] 223. 700 perms  [ ] 224. Called before mutation

  8.7  INSTALL_FILES WRAPPER
       [ ] 225. Argparse tmp via mktemp
       [ ] 226. Cleaned on both success AND argparse error

  8.8  EXTERNAL COMMAND AUDIT
       [ ] 227. command -q preflight  [ ] 228. Failure handling
       [ ] 229. No version assumptions

  8.9  PRE-LOCK VALIDATION (v2.8.0)
       [ ] 230. Usage errors validated BEFORE _acquire_lock

  8.10 DISPATCH QUOTING (v2.8.0)
       [ ] 231. do_func "$TARGET" quoted (rg 'do_\w+ \$' → all quoted)

═══════════════════════════════════════════════════════════════
 PHASE 9: PATTERNS & ANTI-PATTERNS (15 checks)
═══════════════════════════════════════════════════════════════

  9.1  FALSE POSITIVES (do NOT flag)
       [ ] 232. "text"(command) — valid concat
       [ ] 233. Unquoted $ARRAY in for-loops — correct
       [ ] 234. $() inside awk/ExecStart — embedded bash
       [ ] 235. [[:class:]] inside grep -E — char class

  9.2  ANTI-PATTERNS
       [ ] 236. grep -q | ... (dead pipe)
       [ ] 237. cat file | grep (useless cat)
       [ ] 238. test "$var" = "" (use -z)
       [ ] 239. Bare find without command prefix
       [ ] 240. head -1 / tail -1 (use -n 1)
       [ ] 241. Nested substitution without clarity
       [ ] 242. REDIRECT BUG: string trim < "$file" 2>/dev/null on
               nonexistent files leaks stderr → use cat -- 2>/dev/null.
               RUNTIME-only test.

  9.3  STYLE
       [ ] 243. Consistent indentation  [ ] 244. Functions ≤50 lines
       [ ] 245. No dead code  [ ] 246. Comments explain WHY

═══════════════════════════════════════════════════════════════
 PHASE 10: MAGIC NUMBERS & DOCUMENTATION (19 checks)
═══════════════════════════════════════════════════════════════

  10.1 MAGIC NUMBERS
       [ ] 247. All numeric constants named  [ ] 248. Perms documented
       [ ] 249. Thresholds documented  [ ] 250. Timeouts documented
       [ ] 251. Hardware values documented  [ ] 252. 130 = SIGINT
       [ ] 253. TEMP_CPU_WARN/CRIT, TEMP_GPU_WARN/CRIT
       [ ] 254. DISK_ROOT_WARN/CRIT, BOOT_SPACE_WARN/CRIT
       [ ] 255. ROOT_AVAIL_CRIT/WARN (GB), NVME_LIFE_WARN (%)
       [ ] 256. MAX_LOGS, MAX_BACKUPS, CACHE_CLEAN_THRESHOLD
       [ ] 257. BOOT_TIME_WARN, BOOT_TIME_TARGET
       [ ] 258. WATCH_INTERVAL default

  10.2 DOCUMENTATION
       [ ] 259. --help covers all modes/flags
       [ ] 260. Inline comments for non-obvious decisions
       [ ] 261. Cross-refs noted  [ ] 262. Completions generated
       [ ] 263. README: quick-start, options, config ref
       [ ] 264. Changelog covers versions  [ ] 265. LICENSE present

═══════════════════════════════════════════════════════════════
 PHASE 11: TESTING & VALIDATION (23 checks)
═══════════════════════════════════════════════════════════════

  11.1 PREFLIGHT
       [ ] 266. Deps verified  [ ] 267. Disk space checked
       [ ] 268. Network verified  [ ] 269. HW fingerprint validated
       [ ] 270. Kernel version  [ ] 271. systemd version
       [ ] 272. Dep list accuracy (check_deps = actual usage, no stale)

  11.2 CONFIG VALIDATION
       [ ] 273. fish --no-execute on generated  [ ] 274. systemd-analyze verify
       [ ] 275. modprobe -n  [ ] 276. INI section headers
       [ ] 277. udev no empty match  [ ] 278. Hook order programmatic

  11.3 INTERNAL LINT
       [ ] 279. Version sync  [ ] 280. File/case counts
       [ ] 281. Anti-pattern self-scan  [ ] 282. Progress = actual

  11.4 DRY-RUN
       [ ] 283. All writes skipped  [ ] 284. Logged as DRY
       [ ] 285. Gates on ALL write paths

  11.5 ROLLBACK
       [ ] 286. Destructive ops have undo/dry-run
       [ ] 287. Backup before overwrite  [ ] 288. Recovery documented

═══════════════════════════════════════════════════════════════
 PHASE 12: RUNTIME EXECUTION (27 checks)
═══════════════════════════════════════════════════════════════

  Prerequisite: fish installed. Use PASS 3 harness above.

  12.1 STDOUT/STDERR SEPARATION
       [ ] 289. --help: stdout content, 0 stderr
       [ ] 290. --version: stdout version, 0 stderr
       [ ] 291. Op modes: all to stderr, 0 stdout
       [ ] 292. Errors: stderr only, 0 stdout

  12.2 EXIT CODE MATRIX
       [ ] 293. 0: --help, -h, --version, -v, --lint, --completions,
               --test-all, --logs list/system, --dry-run, -n,
               --profile --dry-run, -a --dry-run, --diagnose --gaming --dry-run,
               --all --diagnose --dry-run
       [ ] 294. 2: invalid flag, conflicts, modifier-only (--fix/--stress
               alone), bad --interval, --install-file no path,
               --diff relative/path
       [ ] 295. 1: runtime failures (verify-static no sudo, etc.)
       [ ] 296. Modifier WARN (not exit 2): --interval without parent mode,
               --gaming without --diagnose

  12.3 OPTION VALIDATION
       [ ] 297. Every flag accepted  [ ] 298. Modifier guards enforced
       [ ] 299. Multiple modes → exit 2  [ ] 300. -- stops parsing
       [ ] 301. --interval: missing/non-numeric/0/negative → exit 2
       [ ] 302. --install-file: no path → exit 2 (pre-lock)
       [ ] 303. --diff <path>: non-absolute → 2, non-managed → 1, valid → 0

  12.4 NO_COLOR
       [ ] 304. 0 ANSI escapes across ALL modes with --no-color.
               Includes do_watch clear-screen fallback to newlines (v2.8.3).
               Includes --diagnose --gaming (v3.2.5).

  12.5 DRY-RUN
       [ ] 305. [DRY] messages, 0 filesystem changes

  12.6 INTERNAL CONSISTENCY
       [ ] 306. --lint passes  [ ] 307. --test-all reports correctly
       [ ] 308. --logs no sub-target → exit 2
       [ ] 309. --logs analyze nonexistent → exit 1

  12.7 MODE-SPECIFIC
       [ ] 310. --watch non-tty → exit 1 + error on stderr
       [ ] 311. --no-log: no "Log file:", no .jsonl created
       [ ] 312. --diff <path>: shows single file diff
       [ ] 313. --no-log --version: clean exit 0

  12.8 --PROFILE (v2.8.1)
       [ ] 325. [PROFILE] on stderr, NO_COLOR respected, absent when unset

  12.9 DO_WATCH ISATTY GUARD (v2.8.4)
       [ ] 326. Color output in do_watch gated by isatty 1 (not just
               NO_COLOR). Non-tty stdout suppresses ANSI escapes even
               without --no-color. Regression: rg 'isatty 1' do_watch.

═══════════════════════════════════════════════════════════════
 PHASE 13: GAP ANALYSIS & EDGE CASES (8 checks)
═══════════════════════════════════════════════════════════════

  Use PASS 4 data. Trace actual code paths.

  13.1 RACE CONDITIONS
       [ ] 317. mktemp O_EXCL, no check-use gap
       [ ] 318. No attacker substitution window (mktemp in target dir)

  13.2 ERROR PATH COMPLETENESS
       [ ] 319. Every tmpfile has cleanup on EVERY error branch
       [ ] 320. Credentials erased on every error path
       [ ] 321. Signal cleanup covers all tmpfile patterns (incl ry-argparse.*)

  13.3 LOGIC
       [ ] 322. DRY gates: every state-changing call through _run or explicit
               DRY check. Include do_watch — no writes in watch mode.

  13.4 EDGE CASES
       [ ] 323. do_watch: WATCH_COLS re-read each iteration, cleaned on exit

  13.5 LOCK REGRESSION (v2.8.2)
       [ ] 324. mkdir-only, 0 flock remnants, stale reclaim with --
               terminators, verify_pid race check present

═══════════════════════════════════════════════════════════════
 PHASE 14: v3.1.0–v3.2.5 SPECIFICS (36 checks)
═══════════════════════════════════════════════════════════════

  Use PASS 1 P14 data. Verify helpers, sysctl, regressions, audit fixes,
  race fixes, SIGPIPE, boot sanity, gaming flag, kernel param validation.

  14.1 KVER GLOBALS (v3.1.0)
       [ ] 327. KVER, KVER_MAJOR, KVER_MINOR initialized at top level
               BEFORE _ntsync_state or any kernel-version-dependent code.
               Parse validation: non-numeric fallback to 0.
               Regression: 0 inline uname -r calls outside KVER init.

  14.2 RETURN-VALUE HELPERS (v3.1.0, stdout contract)
       [ ] 328. _ntsync_state: returns exactly one of 5 states via stdout
               (unavailable|builtin|loaded|loaded_nodev|missing). All 6+
               callers capture into local via set -l _ns (_ntsync_state).
               No stderr output.
       [ ] 329. _get_boot_time: returns seconds (float) via stdout, or
               return 1. Callers capture and check $status. No stderr.
       [ ] 330. _find_pacnew_files: returns file paths via stdout. Callers
               capture into list. No stale inline sudo find calls remain.

  14.3 VERIFICATION HELPERS (v3.1.0)
       [ ] 331. _verify_unit_syntax: --user auto-detect via path match
               '*/.config/systemd/user/*'. Passes $user_flag to
               systemd-analyze verify. Handles missing systemd-analyze
               with _warn + return 0.
       [ ] 332. _check_service_active_enabled: checks both is-active AND
               is-enabled. Handles not-installed (file missing) with _warn.
               Callers: amdgpu-performance.service, cpupower-epp.service.

  14.4 HELPER DEDUPLICATION (v3.1.0)
       [ ] 333. No orphaned inline versions of consolidated helpers:
               - 0 inline uname -r (outside KVER init + comments)
               - 0 inline sudo find pacnew (outside _find_pacnew_files)
               - 0 inline systemd-analyze head (outside _get_boot_time)
               - 0 NTSYNC_SUPPORTED global remnants

  14.5 REMOVED-FEATURE REGRESSIONS (v3.1.0)
       [ ] 334. sp5100_tco: not in MODPROBE_BLACKLIST. CachyOS vendor
               blacklist + nowatchdog cmdline handle it.
               rg -i 'sp5100' → 0 hits (or comment-only).
       [ ] 335. btusb: no btusb.enable_autosuspend cmdline param, no USB
               udev ACTION=="bind" rule for btusb, no btusb sysfs verify.
               usbcore.autosuspend=-1 handles globally.
               rg -i 'btusb|enable_autosuspend' → 0 hits (or comment-only).
       [ ] 336. power-profiles-daemon: in MASK array, NOT in PKGS_DEL.
               Prevents dependency reinstallation conflicts.

  14.6 HOOK VALIDATION (v3.1.0)
       [ ] 337. validate_mkinitcpio_hooks --existence-only flag: verify_static
               passes --existence-only when checking installed mkinitcpio.conf.
               Flag skips order checking and only confirms hook existence.
               Full order validation used only for embedded content.

  14.7 SYSCTL.D INTEGRATION (v3.2.0)
       [ ] 341. /etc/sysctl.d/99-ry-sysctl.conf in SYSTEM_DESTINATIONS
               (12th entry). MANAGED_FILE_COUNT = 17. get_file_content
               has matching case with correct printf content.
       [ ] 342. verify_static sysctl section: 4 _chk_grep checks for
               default_qdisc=fq, tcp_congestion_control=bbr,
               tcp_fastopen=3, max_user_watches=524288.
       [ ] 343. verify_runtime sysctl section: reads /proc/sys/ paths for
               all 4 keys, compares against expected values, uses
               cat -- with 2>/dev/null and string trim --.
       [ ] 344. do_diagnose: Sysctl Tuning section present. Checks all 4
               keys with same /proc/sys pattern. Increments checks/issues
               counters correctly.
       [ ] 345. _install_configure_services: sysctl --system reload present
               after resolved restart, gated by file existence check and
               _ask prompt. Failure handled with _warn.
       [ ] 346. do_install_file: sysctl.d path match via
               string match -q '*/sysctl.d/*'. Triggers sysctl --system
               reload with _ask + _run + _warn on failure.

  14.8 AUDIT FIXES (v3.1.1–v3.1.4)
       [ ] 347. _install_finalize: returns 1 when INSTALL_HAD_ERRORS=true.
               Caller (do_install dispatch) checks both $install_status
               and INSTALL_HAD_ERRORS. No silent success on partial failure.
       [ ] 348. cat -- terminators: _run output capture uses cat -- (not
               bare cat). Verify L1110, L1113 region (or equivalent).
               rg 'cat --' should show terminators in capture paths.
       [ ] 349. --description on all functions: every function declaration
               includes --description flag. Function count = description
               count. rg -c '^function ' = rg -c -- '--description'.
       [ ] 350. 71+ inline comments (v3.1.3): section headers, magic number
               annotations, design rationale for lock, credentials, atomic
               writes, hex normalization, vfat skip, NM/IWD gate, GKeyFile
               escape. Spot-check: rg -c '#' shows comment density increase.

  14.9 ORPHAN LOG & RACE FIXES (v3.2.2–v3.2.3)
       [ ] 351. Orphan log cleanup on early exit paths: every exit 2 in arg
               parser preceded by `test "$LOG_FILE" != /dev/null; and rm -f
               -- "$LOG_FILE"`. Covers --diff relative/path, --interval
               invalid/missing, --install-file no path, --help, --version,
               unknown option. Pattern: no exit 2 without LOG_FILE guard.
       [ ] 352. --no-log orphan cleanup: both _cleanup (signal) and
               _cleanup_on_exit (fish_exit) remove install-TIMESTAMP.jsonl
               when LOG_FILE=/dev/null. Covers all 9+ early exit paths.
               rg 'install-.*jsonl' in both handlers.
       [ ] 353. Footer race fix: _FOOTER_WRITTEN set BEFORE printf footer
               (not after). Prevents signal handler from writing duplicate
               JSONL footer between printf and flag set. Trade-off accepted:
               if printf fails after flag, no footer (disk-full would fail
               both paths). rg -A1 '_FOOTER_WRITTEN true' should show
               printf on next line.
       [ ] 354. Log rotation under write lock: rotation gated by _has_lock
               flag. Only write modes (install, clean, diff --fix) rotate.
               Read-only modes defer to next write run. No find+rm before
               _acquire_lock. rg '_has_lock' shows gate pattern.
       [ ] 355. LC_ALL=C on backup rotation sort: ISO-date directory names
               sorted with LC_ALL=C to prevent locale-dependent ordering.
               rg 'LC_ALL=C sort' in _backup_init region.
       [ ] 356. LC_ALL=C on log rotation sort: log file listing sorted
               with LC_ALL=C for consistent oldest-first ordering.
               rg 'LC_ALL=C sort' in log rotation region.

  14.10 SIGPIPE HANDLER (v3.2.5)
       [ ] 357. _cleanup_pipe: --on-signal PIPE handler with exit 141.
               Fish does not auto-ignore SIGPIPE; piping script output to
               head/grep could kill without cleanup or lock release.
               Requirements:
               - Skips all stderr output (pipe may be broken)
               - Writes JSONL footer to LOG_FILE (file write, not pipe)
               - Sets _CLEANUP_DONE=true before _do_cleanup
               - Calls _do_cleanup (tmpfiles, lock, keepalive)
               - Exits 141 (128+13 = SIGPIPE convention)
               - _cleanup_on_exit fish_exit handler recognizes exit 141
               - show_help documents exit code 141
               Cross-ref with check 314.

  14.11 KERNEL PARAM VALIDATION (v3.2.5)
       [ ] 358. _validate_kernel_params: maps cmdline param prefixes to
               CONFIG_ symbols (param_config_map), reads /proc/config.gz,
               warns if cmdline params reference features not compiled in.
               Requirements:
               - Graceful skip when /proc/config.gz unavailable
               - Only maps params that depend on compile-time features
               - nowatchdog intentionally excluded (no-op either way)
               - Checks CONFIG_=y or =m (not =n or absent)
               - Called from verify_runtime
               - Returns mismatch count for caller error tracking

  14.12 BOOT SANITY GATE (v3.2.5)
       [ ] 359. _preflight_boot_sanity: post-rebuild verification gate.
               Called after mkinitcpio -P and sdboot-manage in
               _install_rebuild_boot. Failure sets INSTALL_HAD_ERRORS.
               Requirements:
               - At least one vmlinuz-* exists and is non-zero
               - Every initramfs-*.img is non-zero
               - At least one boot entry .conf references existing kernel
               - Failure message includes "DO NOT REBOOT" + recovery steps
               - Does NOT prevent script completion (sets error flag only)

  14.13 SYSFS TEMP READS (v3.2.5)
       [ ] 360. _gather_temps: reads sysfs hwmon directly instead of
               forking lm_sensors `sensors` command. Consistent with
               do_watch's existing sysfs pattern.
               Requirements:
               - No `sensors` or `lm_sensors` command dependency at runtime
               - Iterates /sys/class/hwmon/hwmon*/temp*_input
               - Reads name file for sensor identification (k10temp, amdgpu)
               - Fan data via /sys/class/hwmon/hwmon*/fan*_input
               - Handles missing/unreadable sysfs files gracefully
               - lm_sensors stays in PKGS_ADD (for sensor detection data)

  14.14 GAMING DIAGNOSTICS FLAG (v3.2.5)
       [ ] 361. _diagnose_gaming extracted behind --gaming flag. Moves
               Vulkan, session, media codecs, Steam/Proton checks into
               separate function enabled by --diagnose --gaming or --all.
               Requirements:
               - GAMING global initialized false at top level
               - CLI parser accepts --gaming, sets GAMING=true
               - --gaming without --diagnose → WARN + ignore (not exit 2)
               - --all + --diagnose auto-enables GAMING=true
               - _diagnose_gaming uses --no-scope-shadowing for counter
                 access (checks/issues from do_diagnose)
               - Function called conditionally: if GAMING=true in do_diagnose
               - --help documents --gaming flag and --diagnose --gaming combo
               - Completions include --gaming

  14.15 DEAD GLOBAL REMOVAL (v3.2.5)
       [ ] 362. MODULES_LOAD and _LOCK_METHOD globals removed.
               MODULES_LOAD: obsolete after modules-load.d removal (v3.1.0).
               _LOCK_METHOD: obsolete after mkdir-only lock (v2.8.2).
               rg 'MODULES_LOAD|_LOCK_METHOD' → 0 hits.
               Cross-ref: check 218 (flock regression), check 143
               (modules-load.d regression).

  14.16 CLEAN DOTFILE FIX (v3.2.5)
       [ ] 363. do_clean: Steam and AUR cache cleanup uses
               find "$d" -mindepth 1 ... instead of rm -rf "$d"/*.
               Shell glob skips dotfiles (e.g., .steam hidden dirs);
               find -mindepth 1 does not. Verify no rm -rf "$d"/* pattern
               remains in do_clean for cache directories.

  14.17 LOG TIMESTAMP SIMPLIFICATION (v3.2.5)
       [ ] 364. _log uses direct date '+%Y-%m-%dT%H:%M:%S' call per
               invocation. No timestamp cache variable (_TS_CACHE or
               similar). No /proc/uptime reads. Trade-off: ~1ms per log
               call, negligible vs I/O. rg '_TS_CACHE|/proc/uptime' → 0.

  14.18 STRING MATCH SEPARATOR FIX (v3.2.5)
       [ ] 365. verify_runtime cmdline check: string match -- separator
               is outside quoted string as Fish end-of-options marker,
               not inside quoted string as literal text ' -- '. Verify
               the pattern uses `string match -q -- <pattern> <string>`
               form, not `string match -q '... -- ...' <string>`.

═══════════════════════════════════════════════════════════════
 PASS 5: FINALIZE
═══════════════════════════════════════════════════════════════

STEP 1: COLLATE

  ```bash
  D=/home/claude/audit-data; O=/home/claude/audit-findings.txt
  test -s "$O" || echo "WARNING: No findings" > "$O"
  for sev in CRITICAL HIGH MED LOW INFO BUG STYLE; do
    echo "$sev: $(rg -c "^\[$sev\]" "$O" 2>/dev/null || echo 0)"
  done
  echo "TOTAL: $(rg -c '^(F-|\[)' "$O" 2>/dev/null || echo 0)"
  ```

STEP 2: SUMMARY TABLE

  Phase  | Checks | Pass | Fail | Info
  -------|--------|------|------|-----
  1      | 20     |      |      |
  2      | 18     |      |      |
  3      | 24     |      |      |
  4      | 24     |      |      |
  5      | 37     |      |      |
  6      | 50     |      |      |
  7      | 24     |      |      |
  8      | 37     |      |      |
  9      | 15     |      |      |
  10     | 19     |      |      |
  11     | 23     |      |      |
  12     | 27     |      |      |
  13     | 8      |      |      |
  14     | 36     |      |      |
  TOTAL  | 362    |      |      |

  CRITICAL: N | HIGH: N | MED: N | LOW: N | INFO: N

  Notes:
  - 232-235: false-positive documentation, always PASS
  - Phase 12: REQUIRES fish execution
  - 296, 298: modifier-only → WARN not exit 2, verify at runtime
  - 242: redirect regression, RUNTIME only
  - 218, 324: lock regression, expect 0 flock hits
  - 325: --profile stderr + NO_COLOR
  - 326: do_watch isatty 1 color guard (v2.8.4 regression)
  - 143: modules-load.d removal regression (v3.1.0)
  - 327: KVER globals, expect 0 inline uname -r outside init
  - 328-330: return-value helpers, stdout contracts
  - 333: helper dedup, expect 0 orphaned inline versions
  - 334-336: removed-feature regressions (sp5100_tco, btusb, ppd)
  - 337: --existence-only hook validation split
  - 338-340: sysctl.d format, vendor non-overlap, 4 required keys
  - 341-346: sysctl.d integration across all modes
  - 347: _install_finalize INSTALL_HAD_ERRORS propagation (v3.1.4)
  - 348: cat -- terminators in _run capture (v3.1.4)
  - 349: --description parity with function count (v3.1.2)
  - 350: inline comment density increase (v3.1.3)
  - 351-352: orphan log cleanup (v3.2.2)
  - 353: footer race — flag before write (v3.2.3)
  - 354: log rotation under write lock (v3.2.3)
  - 355-356: LC_ALL=C on date-sorted file listings (v3.2.3)
  - 314, 357: SIGPIPE handler — _cleanup_pipe, exit 141 (v3.2.5)
  - 358: _validate_kernel_params — cmdline vs /proc/config.gz (v3.2.5)
  - 359: _preflight_boot_sanity — post-rebuild boot gate (v3.2.5)
  - 360: _gather_temps — sysfs hwmon, no lm_sensors fork (v3.2.5)
  - 361: _diagnose_gaming — --gaming flag extraction (v3.2.5)
  - 362: dead global removal — MODULES_LOAD, _LOCK_METHOD (v3.2.5)
  - 363: do_clean dotfile fix — find -mindepth 1 (v3.2.5)
  - 364: _log timestamp simplification (v3.2.5)
  - 365: string match -- separator fix in verify_runtime (v3.2.5)

  Verdict: deploy-ready | fix-required | redesign-needed

  Partial: save findings, mark SKIPPED phases, add COVERAGE line,
  still produce spec, verdict "incomplete — N/14".

STEP 3: SPEC FILE

  SEVERITY: CRITICAL (data loss/security) | HIGH (functional bug) |
  MED (correctness) | LOW (style) | INFO (observation)

  Per finding: F-N | Severity | Phase | Checks | Lines | Category | Detail | Fix

  ```
  FIXES SPEC: <script> <old-ver> → <new-ver>
  Date: YYYY-MM-DD | Findings: N (N CRIT, N HIGH, N MED, N LOW, N INFO)

  --- FIX INSTRUCTIONS ---
  F-1  [SEV]  <summary>
       Checks: N,N  Lines: N,N  Category: <checklist item>
       Before: <exact text>
       After:  <exact replacement>
       Verify: <command>

  --- INFO (no action) ---
  I-1  [INFO]  <desc>  Checks: N  Lines: N

  --- VERSION ---
  Bump: <old> → <new>
  Changelog: v<new> <summary>.

  --- VERIFICATION ---
  1. fish --no-execute script.fish
  2. rg '<old-version>' script.fish README.md  (expect 0)
  3. rg '<new-version>' script.fish README.md  (expect N)
  ```

  Before/After must be exact. Spec self-contained. Version bump if any
  actionable fixes. INFO listed separately.

STEP 4: PACKAGE

  ```bash
  S=script; V=x.y.z; OUT=/mnt/user-data/outputs
  cp /home/claude/audit-${S}-${V}.txt /home/claude/fixes-spec-${V}.txt "$OUT/"
  cd /home/claude && zip "${OUT}/audit-${S}-${V}.zip" audit-${S}-${V}.txt fixes-spec-${V}.txt
  ```

DELIVERABLES: audit-<script>-<version>.txt + fixes-spec-<version>.txt (zipped)
